<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/javascript-guidebook/umi.69d68bc9.css" />
    <script>
      window.routerBase = "/javascript-guidebook/";
    </script>
    <script>
      //! umi version: 3.5.20
    </script>
    <script>
      !(function () {
        var e = localStorage.getItem("dumi:prefers-color"),
          t = window.matchMedia("(prefers-color-scheme: dark)").matches,
          r = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === r[2] ? (t ? r[1] : r[0]) : r.indexOf(e) > -1 ? e : r[0]
        );
      })();
    </script>
    <title>传输层协议 - JavaScript Guidebook</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/computer-networks/computer-network-architecture/transport-layer-protocol" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/javascript-guidebook-favicon.png&#x27;)" href="/javascript-guidebook//">JavaScript Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span><a href="/javascript-guidebook//basic-concept">基本语法</a></span><span><a href="/javascript-guidebook//standard-built-in-objects">内置对象</a></span><span><a href="/javascript-guidebook//core-modules">核心模块</a></span><span><a href="/javascript-guidebook//object-oriented-programming">OOP</a></span><span><a href="/javascript-guidebook//browser-object-model">BOM</a></span><span><a href="/javascript-guidebook//document-object-model">DOM</a></span><span><a aria-current="page" class="active" href="/javascript-guidebook//computer-networks">计算机网络</a></span><span><a href="/javascript-guidebook//design-patterns">设计模式</a></span><span><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/javascript-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/javascript-guidebook-favicon.png&#x27;)" href="/javascript-guidebook//"></a><h1>JavaScript Guidebook</h1><p>JavaScript 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/javascript-guidebook//basic-concept">基本语法</a></li><li><a href="/javascript-guidebook//standard-built-in-objects">内置对象</a></li><li><a href="/javascript-guidebook//core-modules">核心模块</a></li><li><a href="/javascript-guidebook//object-oriented-programming">OOP</a></li><li><a href="/javascript-guidebook//browser-object-model">BOM</a></li><li><a href="/javascript-guidebook//document-object-model">DOM</a></li><li><a aria-current="page" class="active" href="/javascript-guidebook//computer-networks">计算机网络</a></li><li><a href="/javascript-guidebook//design-patterns">设计模式</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/javascript-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/javascript-guidebook//computer-networks">计算机网络</a></li><li><a target="_blank" rel="noopener noreferrer">计算机网络体系</a><ul><li><a href="/javascript-guidebook//computer-networks/computer-network-architecture/computer-networks"><span>计算机网络体系</span></a></li><li><a aria-current="page" class="active" href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol"><span>传输层协议</span></a></li><li><a href="/javascript-guidebook//computer-networks/computer-network-architecture/network-layer-and-data-link-layer-protocol"><span>网络层与数据链路层协议</span></a></li><li><a href="/javascript-guidebook//computer-networks/computer-network-architecture/dns"><span>DNS 域名解析系统</span></a></li><li><a href="/javascript-guidebook//computer-networks/computer-network-architecture/cdn"><span>CDN 内容分发网络</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">HTTP</a><ul><li><a href="/javascript-guidebook//computer-networks/http/http"><span>HTTP</span></a></li><li><a href="/javascript-guidebook//computer-networks/http/http-resource-and-uris"><span>HTTP 资源标识</span></a></li><li><a href="/javascript-guidebook//computer-networks/http/http-message"><span>HTTP 报文格式</span></a></li><li><a href="/javascript-guidebook//computer-networks/http/http-headers"><span>HTTP 首部字段</span></a></li><li><a href="/javascript-guidebook//computer-networks/http/http-status-code"><span>HTTP 状态码</span></a></li><li><a href="/javascript-guidebook//computer-networks/http/http-connection"><span>HTTP 连接</span></a></li><li><a href="/javascript-guidebook//computer-networks/http/http-content-negotiation"><span>HTTP 内容协商</span></a></li><li><a href="/javascript-guidebook//computer-networks/http/cross-origin-resource-sharing"><span>HTTP CORS 跨域资源共享</span></a></li><li><a href="/javascript-guidebook//computer-networks/http/content-security-policy"><span>HTTP CSP 内容安全策略</span></a></li><li><a href="/javascript-guidebook//computer-networks/http/https"><span>HTTPS</span></a></li><li><a href="/javascript-guidebook//computer-networks/http/http2"><span>HTTP2</span></a></li><li><a href="/javascript-guidebook//computer-networks/http/http3"><span>HTTP3</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">Web 安全</a><ul><li><a href="/javascript-guidebook//computer-networks/web-security/same-origin-policy"><span>同源策略</span></a></li><li><a href="/javascript-guidebook//computer-networks/web-security/xss"><span>XSS 跨站脚本攻击</span></a></li><li><a href="/javascript-guidebook//computer-networks/web-security/csrf"><span>CSRF 跨站请求伪造攻击</span></a></li><li><a href="/javascript-guidebook//computer-networks/web-security/ddos"><span>DDoS 攻击</span></a></li><li><a href="/javascript-guidebook//computer-networks/web-security/sql-injection"><span>SQL 注入攻击</span></a></li><li><a href="/javascript-guidebook//computer-networks/web-security/hijacking"><span>流量劫持</span></a></li></ul></li><li><a href="/javascript-guidebook//computer-networks/computer-network-architecture">计算机网络体系</a><ul><li><a href="/javascript-guidebook//computer-networks/computer-network-architecture/hls"><span>HLS 流媒体网络传输协议</span></a></li></ul></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="TCP" data-depth="2"><a href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#tcp"><span>TCP</span></a></li><li title="数据包结构" data-depth="3"><a href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#数据包结构"><span>数据包结构</span></a></li><li title="三次握手" data-depth="3"><a href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#三次握手"><span>三次握手</span></a></li><li title="四次挥手" data-depth="3"><a href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#四次挥手"><span>四次挥手</span></a></li><li title="重传机制" data-depth="3"><a href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#重传机制"><span>重传机制</span></a></li><li title="拥塞控制机制" data-depth="3"><a href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#拥塞控制机制"><span>拥塞控制机制</span></a></li><li title="流量控制机制" data-depth="3"><a href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#流量控制机制"><span>流量控制机制</span></a></li><li title="可靠传输机制" data-depth="3"><a href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#可靠传输机制"><span>可靠传输机制</span></a></li><li title="UDP" data-depth="2"><a href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#udp"><span>UDP</span></a></li><li title="特点" data-depth="3"><a href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#特点"><span>特点</span></a></li><li title="实践" data-depth="3"><a href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#实践"><span>实践</span></a></li><li title="数据通信形式" data-depth="2"><a href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#数据通信形式"><span>数据通信形式</span></a></li><li title="TCP 与 UDP" data-depth="2"><a href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#tcp-与-udp"><span>TCP 与 UDP</span></a></li><li title="参考资料" data-depth="2"><a href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#参考资料"><span>参考资料</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="传输层协议"><a aria-hidden="true" tabindex="-1" href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#传输层协议"><span class="icon icon-link"></span></a>传输层协议</h1><p>传输层（Transport Layer）的主要任务就是负责向两台主机进程之间的通信提供通用的 <strong style="color:red">数据传输服务</strong>。应用进程利用该服务传送应用层报文。</p><p>网络协议族中有两个具有代表性的传输层协议，分别是 TCP 和 UDP。</p><ul><li>传输控制协议 TCP：提供面向连接的，可靠的数据传输服务</li><li>用户数据协议 UDP：提供无连接的，尽最大努力的数据传输服务（不保证数据传输的可靠性）</li></ul><h2 id="tcp"><a aria-hidden="true" tabindex="-1" href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#tcp"><span class="icon icon-link"></span></a>TCP</h2><p><strong>传输控制协议</strong>（Transmission Control Protocol，简称 TCP）是一种 <strong>面向连接</strong>（连接导向）的、可靠的、 基于 IP 协议的传输层协议。</p><ul><li><strong>面向连接</strong>：每条 TCP 连接只能有两个端点（亦即点对点，不可广播、多播），每一条 TCP 连接只能是一对一</li><li><strong>可靠的传输服务</strong>：通过 TCP 连接传送的数据，无差错、不丢失、不重复、并且按序到达，丢包时通过重传机制进而增加时延实现可靠性</li><li><strong>全双工通信</strong>：TCP 允许通信双方的应用进程在任何时候都能发送数据。TCP 连接的两端都设有发送缓存和接收缓存，用来临时存放双方通信的数据</li><li><strong>字节流</strong>：面向字节流，TCP 中的 <strong>流</strong>（Stream）指的是流入进程或从进程流出的字节序列</li><li><strong>流量缓冲</strong>：解决速度不匹配问题</li></ul></div><img alt="TCP 状态机" src="/javascript-guidebook/static/tcp-status-machine.3c0e8fc0.jpeg" width="400"/><div class="markdown"><h3 id="数据包结构"><a aria-hidden="true" tabindex="-1" href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#数据包结构"><span class="icon icon-link"></span></a>数据包结构</h3><p>参考：<a target="_blank" rel="noopener noreferrer" href="https://zh.wikipedia.org/wiki/%E4%BC%A0%E8%BE%93%E6%8E%A7%E5%88%B6%E5%8D%8F%E8%AE%AE">数据包结构<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><p>TCP 首部标志比特有 6 个：URG、ACK、PSH、RST、SYN、FIN</p><table><thead><tr><th align="left">控制位</th><th align="left">名称</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">URG</td><td align="left">Urgent Flag</td><td align="left">紧急指针</td></tr><tr><td align="left">ACK</td><td align="left">Acknowledge Flag</td><td align="left">确认序号有效</td></tr><tr><td align="left">PSH</td><td align="left">Push Flag</td><td align="left">尽可能快地将数据送往接收进程</td></tr><tr><td align="left">RST</td><td align="left">Reset Flag</td><td align="left">可能需要重现创建建 TCP 连接</td></tr><tr><td align="left">SYN</td><td align="left">Synchronize</td><td align="left">同步序号来发起一个连接</td></tr><tr><td align="left">FIN</td><td align="left">Finish</td><td align="left">发送方完成发送任务，要求释放连接</td></tr><tr><td align="left">Seq</td><td align="left">Sequance number</td><td align="left">序列号</td></tr></tbody></table><h3 id="三次握手"><a aria-hidden="true" tabindex="-1" href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#三次握手"><span class="icon icon-link"></span></a>三次握手</h3><p>TCP 提供 <strong style="color:red">面向连接</strong> 的通信传输。面向有连接是指在数据通信开始之前先做好两端之间的准备工作，也就是说无论哪一方向另一方发送数据之前，都必须先在双方之间建立一条连接。</p><p>三次握手是指建立一个 TCP 连接时需要客户端和服务器端总共发送三个包以确认连接的建立。</p><h4 id="握手的目标"><a aria-hidden="true" tabindex="-1" href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#握手的目标"><span class="icon icon-link"></span></a>握手的目标</h4><p>三次握手的目的：</p><ul><li><strong>同步连接双方的 Sequence 序列号和确认号</strong><ul><li>初始序列号 ISN（Initial Sequence Number）</li></ul></li><li><strong>交换 TCP 窗口大小信息</strong><ul><li>如 MSS、窗口比例因子、选择性确认、指定校验和算法</li></ul></li></ul><p>在 Socket 编程中，这一过程由客户端执行 <code>connect</code> 来触发。</p><h4 id="三次握手流程图"><a aria-hidden="true" tabindex="-1" href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#三次握手流程图"><span class="icon icon-link"></span></a>三次握手流程图</h4></div><img alt="三次握手流程图" src="/javascript-guidebook/static/handshake.effe6bec.jpg" width="800"/><div class="markdown"><ol><li><strong>第一次握手</strong>：<strong>建立连接</strong>。客户端发送连接请求报文段，将标志比特位 SYN 置为 1，随机产生一个序列号码 Sequence Number 值为 X（由操作系统动态随机选取一个 32 位长的序列号），并将该数据包发送给服务端，客户端进入 <code>SYN_SENT</code> 状态，等待服务端确认。</li><li><strong>第二次握手</strong>：<strong>服务端收到 SYN 报文段</strong>。服务端收到数据包后需要对标志位 SYN 报文段进行确认，确认后设置确认号码 Acknowledgment Number 为 X+1（Sequence Number+1）；同时，自己还要发送 SYN 请求信息（以建立服务端对客户端的连接），将 SYN 设置为 1，设置 Sequence Number 值为 Y（由操作系统动态随机选取一个 32 位长的序列号），服务端将上述所有信息放到一个报文段（即 SYN+ACK 报文段）中，一并发送给客户端<strong>以确认建立连接请求</strong>，服务端进入 <code>SYN_RCVD</code> 状态。</li><li><strong>第三次握手</strong>：<strong>客户端收到服务端的 SYN+ACK 报文段</strong>。确认后，然后将 Acknowledgment Number 设置为 Y+1，向服务端发送 ACK 报文段，这个报文段发送完毕后，客户端和服务器端进入 ESTABLISHED 状态，完成三次握手，随后客户端与服务器端之间可以开始传输数据了。</li></ol><p>握手过程中传送的包里<span style="font-weight:bold;color:red">不包含数据</span>，只有三次握手完毕后，客户端与服务器才正式开始传送数据。理想状态下，TCP 连接一旦建立，在通信双方中的任何一方主动关闭连接之前，TCP 连接都将被一直保持下去。</p><h4 id="握手报文"><a aria-hidden="true" tabindex="-1" href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#握手报文"><span class="icon icon-link"></span></a>握手报文</h4><p>SYN 报文</p></div><img alt="三次握手-1" src="/javascript-guidebook/static/tcp-handshaking-1.e62fef8d.jpg" width="640"/><div class="markdown"><p>SYN/ACK 报文</p></div><img alt="三次握手-2" src="/javascript-guidebook/static/tcp-handshaking-2.051acb7e.jpg" width="640"/><div class="markdown"><p>ACK 报文</p></div><img alt="三次握手-3" src="/javascript-guidebook/static/tcp-handshaking-3.13f50c14.jpg" width="640"/><div class="markdown"><h4 id="其他问题"><a aria-hidden="true" tabindex="-1" href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#其他问题"><span class="icon icon-link"></span></a>其他问题</h4><p><strong>未连接队列</strong></p><p>在三次握手协议中，服务器维护一个未连接队列，该队列为每个客户端的 SYN 包（syn=j）开设一个条目，该条目表明服务器已收到 SYN 包，并向客户端发出确认，正在等待客户端的确认包。这些条目所标识的连接在服务器处于 <code>SYN_RECV</code> 状态，当服务器收到客户端的确认包时，删除该条目，服务器进入 <code>ESTABLISHED</code> 状态。</p><p><strong>为什么建立 TCP 连接需要三次握手？</strong></p><p>主要是为了防止服务端开启无用的连接。</p><p>因为我们知道网络传输是有延时的，因为终端间隔了非常远的距离，数据包通过光纤以及各种中间代理服务器进行传输，但是在服务端和客户端的传输过程中，往往由于网络传输的不稳定原因丢失了数据包，客户端一直没有收到服务端返回的数据包，客户端可能设置了超时时间关闭了连接创建，那么就会再发起新的请求。如果没有第三次握手，服务端是不知道客户端到底有没有接收到服务端返回给他的数据的，客户端也没有一个确认说要关闭还是要创建这个请求，服务端的端口就一直开着，等着客户端发送实际的请求数据，那么这个时候开销就浪费了，服务端不知道这个连接已经创建失败了，可能客户端已经创建别的连接去了。</p><p>所以我们需要三次握手来确认这个过程，让服务端和客户端能及时察觉到网络原因导致的网络连接的关闭的问题，从而规避网络传输中因为延时导致导致的服务器开销问题。</p><p><strong>三次握手中的第一次握手可以携带数据吗？</strong></p><p>不可以，因为三次握手还没完成。</p><p><strong>第三次握手可以发送数据吗？为何？</strong></p><p>可以。因为能够发出第三次握手报文的主机，肯定接收到第二次（来自服务端）的握手报文。因为伪造 IP 的主机不会收到第二次报文。</p><p><strong>对方难道不可以将数据缓存下来，等握手成功后再提交给应用程序？</strong></p><p>这样会放大 SYN FLOOD 攻击。如果攻击者伪造了成千上万的握手报文，携带了 1K+ 字节的数据，而接收方会开辟大量的缓存来容纳这些巨大数据，内存会很容易耗尽，从而拒绝服务。</p><h3 id="四次挥手"><a aria-hidden="true" tabindex="-1" href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#四次挥手"><span class="icon icon-link"></span></a>四次挥手</h3><p>四次挥手即终止 TCP 连接，就是指断开一个 TCP 连接时，需要客户端和服务端总共发送 4 个包以确认连接的断开。在 Socket 编程中，这一过程由客户端或服务端任一方执行 <code>close</code> 来触发。</p><p>由于 TCP 连接是<span style="font-weight:bold;color:red">全双工</span>的，因此，每个方向都必须要<strong>单独进行关闭</strong>，这一原则是当一方完成数据发送任务后，发送一个 <code>FIN</code> 来终止这一方向的连接，收到一个 <code>FIN</code> 只是意味着这一方向上没有数据流动了，即不会再收到数据了，但是在这个 TCP 连接上仍然能够发送数据，直到这一方向也发送了 <code>FIN</code>。首先进行关闭的一方将执行主动关闭，而另一方则执行被动关闭。</p><p><strong>四次挥手流程图</strong></p></div><img alt="四次挥手流程图" src="/javascript-guidebook/static/wave.41ef0005.jpg" width="800"/><div class="markdown"><ol><li><strong>第一次挥手</strong>：客户端设置 Sequence Number，发送一个 <code>FIN</code> 报文段，用于关闭客户端到服务器端的数据传送，客户端进入 <code>FIN_WAIT_1</code> 状态。意思是说「我客户端没有数据要发给你了」，但是如果你服务器端还有数据没有发送完成，则不必急着关闭连接，可以继续发送数据。</li><li><strong>第二次挥手</strong>：服务器端收到 <code>FIN</code> 报文段，回复 <code>ACK</code> 报文段，Acknowledgment Number 为 Sequence Number 加 1，告诉客户端，你的请求我收到了，我同意你的关闭请求。这个时候客户端就进入 <code>FIN_WAIT_2</code> 状态。</li><li><strong>第三次挥手</strong>：当服务器端确定数据已发送完成，则向客户端发送 <code>FIN</code> 报文段，告诉客户端，好了，我这边数据发完了，准备好关闭连接了。服务器端进入 <code>LAST_ACK</code> 状态。</li><li><strong>第四次挥手</strong>：客户端收到 <code>FIN</code> 报文段后，就知道可以关闭连接了，但是他还是不相信网络，怕服务器端不知道要关闭，所以发送 <code>ACK</code> 报文段回复服务端，然后进入 <code>TIME_WAIT</code> 状态，如果服务端端没有收到 <code>ACK</code> 则可以重传。服务器端收到 <code>ACK</code> 后，就知道可以断开连接了。客户端等待了 2MSL（通常是两分钟）后依然没有收到回复，则证明服务器端已正常关闭，那好，我客户端也可以关闭连接了。最终完成了四次握手。</li></ol><blockquote><p>MSL（Maximum Segment Lifetime）报文最大生存时间。维持 2MSL 时长的 TIME-WAIT 状态，保证至少一次报文的往返时间内端口是不可复用。</p></blockquote><ul><li>第一次挥手是<strong>服务端确认客户端需要断开连接</strong></li><li>第二次挥手是<strong>客户端确认服务器接收断开请求</strong></li><li>第三次挥手是<strong>客户端确认服务器数据发完，断开连接</strong></li><li>第四次挥手是<strong>服务端确认客户端断开连接，断开连接</strong></li></ul><p>所以如果服务端的数据全部发送完，是没有第三次挥手，直接进入第四次挥手。</p><p><strong>为什么断开 TCP 连接需要四次挥手？</strong></p><p>由于 TCP 连接采取全双工的通信方式，因此每个方向都必须单独进行关闭，这个原则是当一方完成它的数据发送任务后就能发送一个 <code>FIN</code> 来终止这个方向的连接。收到一个 <code>FIN</code> 只意味着这一方向上没有数据流动，一个 TCP 连接在收到一个 <code>FIN</code> 后仍能发送数据。首先进行关闭的一方将执行主动关闭，而另一方执行被动关闭。</p><p><strong>为什么基于 TCP 的程序往往都有个应用层的心跳检测机制？</strong></p><p>TCP 建立链接后，只是在两端的内核里面维持 TCP 信息，实际上并没有一个物理的连接通路，对端这个时候挂了，谁也不知道。</p><h3 id="重传机制"><a aria-hidden="true" tabindex="-1" href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#重传机制"><span class="icon icon-link"></span></a>重传机制</h3><h3 id="拥塞控制机制"><a aria-hidden="true" tabindex="-1" href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#拥塞控制机制"><span class="icon icon-link"></span></a>拥塞控制机制</h3><h3 id="流量控制机制"><a aria-hidden="true" tabindex="-1" href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#流量控制机制"><span class="icon icon-link"></span></a>流量控制机制</h3><h3 id="可靠传输机制"><a aria-hidden="true" tabindex="-1" href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#可靠传输机制"><span class="icon icon-link"></span></a>可靠传输机制</h3><h2 id="udp"><a aria-hidden="true" tabindex="-1" href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#udp"><span class="icon icon-link"></span></a>UDP</h2><p>用户数据报协议（User Datagram Protocol，UDP），又称使用者资料包协定，是一个简单的面向数据包的传输层协议，正式规范为 RFC 768。</p><p>在 TCP/IP 模型中，UDP 为网络层以上和应用层以下提供了一个简单的接口。UDP 只提供数据的不可靠传递，它一旦把应用程序发给网络层的数据发送出去，就不保留数据备份（所以 UDP 有时候也被认为是不可靠的数据报协议）。UDP 在 IP 数据报的头部仅仅加入了复用和数据校验（字段）。</p><h3 id="特点"><a aria-hidden="true" tabindex="-1" href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#特点"><span class="icon icon-link"></span></a>特点</h3><ul><li><strong style="color:red">无需建立连接</strong>（减少延迟）</li><li>尽最大努力交付，即不保证可靠交付，因此主机不需要维持复杂的链接状态</li><li>UDP 的首部开销小，只有 8 个字节，比 TCP 的 20 个字节的首部要短</li><li>没有拥塞控制，因此网络出现拥塞不会使源主机的发送速率降低（对实时应用很有用，如直播，实时视频会议等）</li><li>支持一对一、一对多、多对一和多对多的交互通信</li></ul><h3 id="实践"><a aria-hidden="true" tabindex="-1" href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#实践"><span class="icon icon-link"></span></a>实践</h3><p><strong>基于 UDP 协议的有：</strong></p><ul><li>域名系统（DNS）</li><li>简单网络管理协议（SNMP）</li><li>动态主机配置协议（DHCP）</li><li>路由信息协议（RIP）</li><li>自举协议（BOOTP）</li><li>简单文件传输协议（TFTP）</li></ul><h2 id="数据通信形式"><a aria-hidden="true" tabindex="-1" href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#数据通信形式"><span class="icon icon-link"></span></a>数据通信形式</h2><ul><li>单工数据传输只支持数据在一个方向上传输</li><li>半双工数据传输允许数据在两个方向上传输，但是，在某一时刻，只允许数据在一个方向上传输，它实际上是一种切换方向的单工通信</li><li>全双工数据通信允许数据同时在两个方向上传输，因此，<strong>全双工通信是两个单工通信方式的结合，它要求发送设备和接收设备都有独立的接收和发送能力</strong></li></ul><h2 id="tcp-与-udp"><a aria-hidden="true" tabindex="-1" href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#tcp-与-udp"><span class="icon icon-link"></span></a>TCP 与 UDP</h2><table><thead><tr><th align="left"></th><th align="left">TCP</th><th align="left">UDP</th></tr></thead><tbody><tr><td align="left">连接性</td><td align="left">面向连接</td><td align="left">无连接</td></tr><tr><td align="left">双工性</td><td align="left">全双工（1:1）</td><td align="left"><code>n:m</code></td></tr><tr><td align="left">可靠性</td><td align="left">可靠（重传机制）</td><td align="left">不可靠（丢包后数据丢失）</td></tr><tr><td align="left">有序性</td><td align="left">有序（通过 SYN 排序）</td><td align="left">无序</td></tr><tr><td align="left">有界性</td><td align="left">无，有沾包情况</td><td align="left">有消息边界，无沾包</td></tr><tr><td align="left">拥塞控制</td><td align="left">有</td><td align="left">无</td></tr><tr><td align="left">传输速度</td><td align="left">慢</td><td align="left">快</td></tr><tr><td align="left">量级</td><td align="left">低</td><td align="left">20-60 字节</td></tr><tr><td align="left">头部大小</td><td align="left">高</td><td align="left">8 字节</td></tr></tbody></table><h2 id="参考资料"><a aria-hidden="true" tabindex="-1" href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol#参考资料"><span class="icon icon-link"></span></a>参考资料</h2><ul><li><a target="_blank" rel="noopener noreferrer" href="https://zh.wikipedia.org/wiki/%E4%BC%A0%E8%BE%93%E6%8E%A7%E5%88%B6%E5%8D%8F%E8%AE%AE">📖 维基百科：传输控制协议<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://juejin.im/post/5ba895a06fb9a05ce95c5dac">📝 TCP 协议详解<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://juejin.im/post/5a069b6d51882509e5432656">📝 一篇文章带你熟悉 TCP/IP 协议<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://juejin.im/post/5ba3b68c6fb9a05d287345ab">📝 前端必须懂的计算机网络知识<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="http://jm.taobao.org/2017/06/08/20170608/">📝 就是要你懂 TCP<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://segmentfault.com/a/1190000024571707">📝 TCP / IP 协议没有哪篇文章能讲的这么明明白白！<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/javascript-guidebook/edit/master/docs/computer-networks/computer-network-architecture/transport-layer-protocol.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last update: ">12/1/2021 18:35:06</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/javascript-guidebook/umi.61ecbf97.js"></script>
  </body>
</html>
