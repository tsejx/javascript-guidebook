(window.webpackJsonp=window.webpackJsonp||[]).push([[208],{353:function(t,s,a){"use strict";a.r(s);var n=a(0),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"web-socket"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#web-socket"}},[t._v("#")]),t._v(" Web Socket")]),t._v(" "),a("p",[t._v("WebSocket 作为 HTML5 一种新的协议，实现了浏览器和服务器双全工通信（full-duplex）。")]),t._v(" "),a("ul",[a("li",[t._v("连接协商和同源策略")]),t._v(" "),a("li",[t._v("与既有 HTTP 基础设施的互操作")]),t._v(" "),a("li",[t._v("基于消息的通信和高效消息分帧")]),t._v(" "),a("li",[t._v("子协议协商及可扩展能力")])]),t._v(" "),a("h2",{attrs:{id:"建立通信"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#建立通信"}},[t._v("#")]),t._v(" 建立通信")]),t._v(" "),a("p",[t._v("WebSocket 通过构造函数创建一个 WebSocket 用于与服务器进行连接，返回一个 WebSocket 实例。通过这个实例监听事件，这些事件可以让我们知道"),a("strong",[t._v("什么时候建立连接")]),t._v("，"),a("strong",[t._v("什么时候服务器发消息过来")]),t._v("，"),a("strong",[t._v("什么时候发生了故障")]),t._v("，"),a("strong",[t._v("什么时候关闭连接")]),t._v("。")]),t._v(" "),a("h3",{attrs:{id:"语法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#语法"}},[t._v("#")]),t._v(" 语法")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("WebSocket")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" protocols"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("ul",[a("li",[a("code",[t._v("url")]),t._v("："),a("code",[t._v("ws(wss)://ip:port/url")]),t._v(" （wss 是 WebSocketSource 缩写）")]),t._v(" "),a("li",[a("code",[t._v("protocols")]),t._v("：可以使用的字协议包括 XMPP（可扩展息处理现场协议）、SOAP（简单对象访问协议）或者自定义协议")])]),t._v(" "),a("h3",{attrs:{id:"属性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#属性"}},[t._v("#")]),t._v(" 属性")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("属性")]),t._v(" "),a("th",[t._v("说明")]),t._v(" "),a("th",[t._v("类型")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[a("code",[t._v("onopen")])]),t._v(" "),a("td",[t._v("服务器响应 WebSocket 连接请求后的回调函数")]),t._v(" "),a("td",[t._v("EventListener")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("onmessage")])]),t._v(" "),a("td",[t._v("接收到来自服务器的数据时触发的回调函数（WebSocket 还可以处理二进制数据，这种数据作为 Blob 消息或者 ArrayBuffer 消息。因为设置 WebSocket 消息二进制数据类型的应用会影响二进制消息，所以必须在读取数据之前决定用于客户端的二进制数据的类型）")]),t._v(" "),a("td",[t._v("EventListener")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("onerror")])]),t._v(" "),a("td",[t._v("响应意外故障的时候出发，如果你接收一个 Error 事件，可以预期很快就会触发 "),a("code",[t._v("close")]),t._v(" 事件。Error 事件处理程序时调用服务器重连逻辑以及处理来自 WebSocket 对象的异常的最佳场所。")]),t._v(" "),a("td",[t._v("EventListener")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("onclose")])]),t._v(" "),a("td",[t._v("WebSocket 连接关闭后的回调函数")]),t._v(" "),a("td",[t._v("EventListener")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("binaryType")])]),t._v(" "),a("td",[t._v("指示由连接发送的二进制数据的类型的字符串")]),t._v(" "),a("td",[t._v("DOMString")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("bufferedAmount")])]),t._v(" "),a("td",[t._v("（只读）未发送至服务器的字节数")]),t._v(" "),a("td",[t._v("unsigned long")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("extensions")])]),t._v(" "),a("td",[t._v("（只读）服务器选择的扩展")]),t._v(" "),a("td",[t._v("DOMString")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("protocol")])]),t._v(" "),a("td",[t._v("服务器选择的下属协议")]),t._v(" "),a("td",[t._v("DOMString")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("readyState")])]),t._v(" "),a("td",[t._v("当前的连接状态")]),t._v(" "),a("td",[t._v("unsigned short")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("url")])]),t._v(" "),a("td",[t._v("（只读）WebSocket 的绝对路径")]),t._v(" "),a("td")])])]),t._v(" "),a("h3",{attrs:{id:"连接状态"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#连接状态"}},[t._v("#")]),t._v(" 连接状态")]),t._v(" "),a("p",[a("code",[t._v("readyState")]),t._v(" 报告连接状态：")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("特性常量")]),t._v(" "),a("th",[t._v("值")]),t._v(" "),a("th",[t._v("状态")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("WebSocket.CONNECTING")]),t._v(" "),a("td",[t._v("0")]),t._v(" "),a("td",[t._v("连接正在进行中，但还未建立")])]),t._v(" "),a("tr",[a("td",[t._v("WebSocket.OPEN")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("连接已经建立，消息可以在客户端接收")])]),t._v(" "),a("tr",[a("td",[t._v("WebSocket.CLOSING")]),t._v(" "),a("td",[t._v("2")]),t._v(" "),a("td",[t._v("连接正在进行关闭握手")])]),t._v(" "),a("tr",[a("td",[t._v("WebSocket.CLOSED")]),t._v(" "),a("td",[t._v("3")]),t._v(" "),a("td",[t._v("连接以及功能关闭，不能打开")])])])]),t._v(" "),a("h3",{attrs:{id:"方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#方法"}},[t._v("#")]),t._v(" 方法")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("方法")]),t._v(" "),a("th",[t._v("说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[a("code",[t._v("close([code [, reason]])")])]),t._v(" "),a("td",[t._v("关闭当前链接（"),a("code",[t._v("code")]),t._v(" 可选参数，指示状态代码的数字值，解释连接正在关闭的原因。如果未指定此参数，则假定默认值为 1000（表示正常的“事务完成”关闭）；"),a("code",[t._v("reason")]),t._v(" 可选参数，一个人类可读的字符串，解释连接正在关闭的原因。该字符串必须不超过 123 个字符的 UTF-8 文本）")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("send(data)")])]),t._v(" "),a("td",[t._v("连接打开时向服务器发送数据")])])])]),t._v(" "),a("h4",{attrs:{id:"code-附录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#code-附录"}},[t._v("#")]),t._v(" Code 附录")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("状态代码")]),t._v(" "),a("th",[t._v("状态")]),t._v(" "),a("th",[t._v("说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("1000")]),t._v(" "),a("td",[t._v("正在关闭")]),t._v(" "),a("td",[t._v("会话成功完成时发送此状态码")])]),t._v(" "),a("tr",[a("td",[t._v("1001")]),t._v(" "),a("td",[t._v("离开")]),t._v(" "),a("td",[t._v("因应用程序离开且不期望后续的连接尝试而关闭连接时，发送此状态码。服务器可能关闭，或者客户端应用程序可能关闭")])]),t._v(" "),a("tr",[a("td",[t._v("1002")]),t._v(" "),a("td",[t._v("协议错误")]),t._v(" "),a("td",[t._v("当因协议错误而关闭连接时发送此状态码")])]),t._v(" "),a("tr",[a("td",[t._v("1003")]),t._v(" "),a("td",[t._v("不可接受的数据类型")]),t._v(" "),a("td",[t._v("当应用程序接收到一条无法处理的意外类型消息时发送此状态码")])]),t._v(" "),a("tr",[a("td",[t._v("1004")]),t._v(" "),a("td",[t._v("保留")]),t._v(" "),a("td",[t._v("禁用状态码。根据 RFC 6455，这个状态码保留，可能在未来定义")])]),t._v(" "),a("tr",[a("td",[t._v("1005")]),t._v(" "),a("td",[t._v("保留")]),t._v(" "),a("td",[t._v("禁用状态码。WebSocket API 用此状态码表示没有接收到任何代码")])]),t._v(" "),a("tr",[a("td",[t._v("1006")]),t._v(" "),a("td",[t._v("保留")]),t._v(" "),a("td",[t._v("禁用状态码。WebSocket API 用此状态码表示连接异常关闭")])]),t._v(" "),a("tr",[a("td",[t._v("1007")]),t._v(" "),a("td",[t._v("无效数据")]),t._v(" "),a("td",[t._v("在接收一个格式与消息类型不匹配的消息之后发送此状态码。如果文本消息包含错误格式的 UTF-8 数据，连接应该用这个代码关闭")])]),t._v(" "),a("tr",[a("td",[t._v("1008")]),t._v(" "),a("td",[t._v("消息违反政策")]),t._v(" "),a("td",[t._v("当应用程序由于其他代码所不包含的原因终止连接，或者不希望泄露消息无法处理的原因时返回此状态码")])]),t._v(" "),a("tr",[a("td",[t._v("1009")]),t._v(" "),a("td",[t._v("消息过大")]),t._v(" "),a("td",[t._v("当接收的消息太大，应用程序无法处理时发送此状态码（记住，帧的载荷长度最多为 64 字节。即使你有一个大服务器，有些消息也仍然过大）。")])]),t._v(" "),a("tr",[a("td",[t._v("1010")]),t._v(" "),a("td",[t._v("需要扩展")]),t._v(" "),a("td",[t._v("当应用程序需要一个或者多个服务器无法协商的特殊扩展时，从客户端（浏览器）发送此状态码。")])]),t._v(" "),a("tr",[a("td",[t._v("1011")]),t._v(" "),a("td",[t._v("意外情况")]),t._v(" "),a("td",[t._v("当应用程序由于不可预见的原因，无法继续处理连接时，发送此状态码")])]),t._v(" "),a("tr",[a("td",[t._v("1015")]),t._v(" "),a("td",[t._v("TLS 失败（保留）")]),t._v(" "),a("td",[t._v("禁用状态码。WebSocket API 用这个代码表示 TLS 在 WebSocket 握手之前失败。")])]),t._v(" "),a("tr",[a("td",[t._v("0~999")]),t._v(" "),a("td",[t._v("禁止")]),t._v(" "),a("td",[t._v("1000 以下的代码是无效的，不能用于任何目的")])]),t._v(" "),a("tr",[a("td",[t._v("1000~2999")]),t._v(" "),a("td",[t._v("保留")]),t._v(" "),a("td",[t._v("这些代码保留以用于扩展和 WebSocket 协议的修订版本。按照标准规定使用这些代码，参见表 3-4")])]),t._v(" "),a("tr",[a("td",[t._v("3000~3999")]),t._v(" "),a("td",[t._v("需要注册")]),t._v(" "),a("td",[t._v("这些状态码用于“程序库、框架和应用程序”。这些状态码应该在 IANA（互联网编号分配机构）公开注册")])]),t._v(" "),a("tr",[a("td",[t._v("4000~4999")]),t._v(" "),a("td",[t._v("私有")]),t._v(" "),a("td",[t._v("在应用程序中将这些状态码用于自定义用途。因为它们没有注册，所以不要期望它们能被其他 WebSocket 广泛理解")])])])]),t._v(" "),a("h3",{attrs:{id:"示例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#示例"}},[t._v("#")]),t._v(" 示例")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建安全的WebSocket连接(wss)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" ws "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WebSocket")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'ws://github.websocket.org'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 连接建立时调用")]),t._v("\nws"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("addEventListener")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'open'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 向服务端发送消息")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("send")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'TEST!'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 接收服务端响应的消息")]),t._v("\nws"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("addEventListener")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'message'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("err")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 连接关闭时调用")]),t._v("\nws"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("addEvenetListener")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'close'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("err")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'WebSocketClosed!'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 连接错误时调用(并且会关闭连接)")]),t._v("\nws"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("addEventListener")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'error'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("err")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'WebSocketError!'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("ws"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("binaryType "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'blob'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nws"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onmessage")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("e")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("instanceof")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Blob")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Blob'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" b "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Blob")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("ws"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("binaryType "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'arraybuffer'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nws"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onmessage")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("e")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("instanceof")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ArrayBuffer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'ArrayBuffer'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" a "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Uint8Array")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h2",{attrs:{id:"websocket-协议"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#websocket-协议"}},[t._v("#")]),t._v(" WebSocket 协议")]),t._v(" "),a("p",[t._v("WebSocket 协议有两部分：握手、数据传输。")]),t._v(" "),a("h3",{attrs:{id:"握手请求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#握手请求"}},[t._v("#")]),t._v(" 握手请求")]),t._v(" "),a("p",[t._v("WebSocket 协议是为了浏览器实现与服务器的全双工通信和 HTTP 协议在浏览器端的广泛应用，因此 WebSocket 的握手是 HTTP 请求的升级。")]),t._v(" "),a("p",[t._v("建立 WebSocket 连接的请求头：")]),t._v(" "),a("div",{staticClass:"language-http extra-class"},[a("pre",{pre:!0,attrs:{class:"language-http"}},[a("code",[a("span",{pre:!0,attrs:{class:"token request-line"}},[a("span",{pre:!0,attrs:{class:"token property"}},[t._v("GET")]),t._v(" /chat HTTP/1.1")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Host:")]),t._v(" server.example.com\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Upgrade:")]),t._v(" websocket\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Connection:")]),t._v(" Upgrade\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Sec-WebSocket-Key:")]),t._v(" x3JJHMbDL1EzLkh9GBhXDw==\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Sec-WebSocket-Protocol:")]),t._v(" chat, superchat\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Sec-WebSocket-Version:")]),t._v(" 13\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Origin:")]),t._v(" http://example.com\n")])])]),a("table",[a("thead",[a("tr",[a("th",[t._v("头字段")]),t._v(" "),a("th",[t._v("说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("Host")]),t._v(" "),a("td",[t._v("（必填）WebSocket 服务器主机名")])]),t._v(" "),a("tr",[a("td",[t._v("Upgrade")]),t._v(" "),a("td",[t._v("（必填）值必须为 "),a("code",[t._v("websocket")])])]),t._v(" "),a("tr",[a("td",[t._v("Connection")]),t._v(" "),a("td",[t._v("（必填）值必须为 "),a("code",[t._v("Upgrade")])])]),t._v(" "),a("tr",[a("td",[t._v("Sec-WebSocket-Key")]),t._v(" "),a("td",[t._v("（必填）Base64 encode 编码的随机 16 字节长的字符序列")])]),t._v(" "),a("tr",[a("td",[t._v("Sec-WebSocket-Protocol")]),t._v(" "),a("td",[t._v("（选填）可用选项有子协议选择器")])]),t._v(" "),a("tr",[a("td",[t._v("Sec-WebSocket-Version")]),t._v(" "),a("td",[t._v("（必填）WebSocket Draft（协议版本）")])]),t._v(" "),a("tr",[a("td",[t._v("Origin")]),t._v(" "),a("td",[t._v("（浏览器必填）头域（ RFC6454） 用于保护 WebSocket 服务器不被未授权的运行在浏览器的脚本跨源使用 WebSocket API")])])])]),t._v(" "),a("p",[t._v("WebSocket 客户端将上述请求发送到服务器。如果是调用浏览器的 WebSocket API，浏览器会自动完成完成上述请求头。")]),t._v(" "),a("h2",{attrs:{id:"相关类库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#相关类库"}},[t._v("#")]),t._v(" 相关类库")]),t._v(" "),a("ul",[a("li",[t._v("react-websocket")])]),t._v(" "),a("h2",{attrs:{id:"兼容性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#兼容性"}},[t._v("#")]),t._v(" 兼容性")]),t._v(" "),a("p",[t._v("语法部分错误")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("IE")]),t._v(" "),a("th",[t._v("Edge")]),t._v(" "),a("th",[t._v("Firefox")]),t._v(" "),a("th",[t._v("Chrome")]),t._v(" "),a("th",[t._v("Safari")]),t._v(" "),a("th",[t._v("Opera")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("11")]),t._v(" "),a("td",[t._v("18")]),t._v(" "),a("td",[t._v("63")]),t._v(" "),a("td",[t._v("70")]),t._v(" "),a("td",[t._v("12")]),t._v(" "),a("td",[t._v("56")])])])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 兼容代码")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" ws "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" window"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("WebSocket\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("window"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("WebSocket")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" protocol"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("window"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MozWebSocket")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" protocol"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("hr"),t._v(" "),a("p",[a("strong",[t._v("参考资料：")])]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://juejin.im/entry/58bd0579128fe1007e5c62c7",target:"_blank",rel:"noopener noreferrer"}},[t._v("WebSocket 浅析"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://juejin.im/entry/57a993750a2b5800586a9d3f",target:"_blank",rel:"noopener noreferrer"}},[t._v("WebSocket 粗谈"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://juejin.im/post/5a1bdf676fb9a045055dd99d",target:"_blank",rel:"noopener noreferrer"}},[t._v("WebSocket 探秘"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.cnblogs.com/houjl/p/10812519.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("React 加入 WebSocket"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=e.exports}}]);