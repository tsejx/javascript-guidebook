---
nav:
  title: è®¡ç®—æœºç½‘ç»œ
  order: 8
group:
  title: Web å®‰å…¨
  order: 4
title: åŒæºç­–ç•¥
order: 1
---

# åŒæºç­–ç•¥

**åŒæºç­–ç•¥**é™åˆ¶ä»ä¸€ä¸ªæºåŠ è½½çš„æ–‡æ¡£æˆ–è„šæœ¬å¦‚ä½•ä¸æ¥è‡ªå¦ä¸€ä¸ªæºçš„èµ„æºè¿›è¡Œäº¤äº’ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äºéš”ç¦»æ½œåœ¨æ¶æ„æ–‡ä»¶çš„å…³é”®çš„å®‰å…¨æœºåˆ¶ã€‚

åŒæºéœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢ï¼š

- åè®®ç›¸åŒ
- åŸŸåç›¸åŒ
- ç«¯å£ç›¸åŒ

ä»¥ `http://www.a.com` ä¸ºä¾‹

- `http://www.a.com/foo` åŒæº
- `http://a.com/foo` ä¸åŒæºï¼ˆåŸŸåä¸åŒï¼‰
- `http://a.edu/foo` ä¸åŒæºï¼ˆåŸŸåä¸åŒï¼‰
- `http://b.a.com/foo` ä¸åŒæºï¼ˆåŸŸåä¸åŒï¼‰
- `http://a.com:81/foo` ä¸åŒæºï¼ˆç«¯å£ä¸åŒï¼‰
- `https://a.com/foo` ä¸åŒæºï¼ˆåè®®ä¸åŒï¼‰

å¦‚æœæ˜¯éåŒæºï¼Œåˆ™ä»¥ä¸‹è¡Œä¸ºä¼šå—åˆ°é™åˆ¶ï¼š

- Cookieã€LocalStorage å’Œ IndexDB æ— æ³•è¯»å–
- DOM æ— æ³•è·å–
- AJAX è¯·æ±‚ä¸èƒ½å‘é€

**ä¸ºä»€ä¹ˆè¦å®ç°è·¨åŸŸè¯·æ±‚ï¼Ÿ**

å·¥ç¨‹æœåŠ¡åŒ–åï¼Œä¸åŒèŒè´£çš„æœåŠ¡åˆ†æ•£åœ¨ä¸åŒçš„å·¥ç¨‹ä¸­ï¼Œå¾€å¾€è¿™äº›å·¥ç¨‹çš„åŸŸåæ˜¯ä¸åŒçš„ï¼Œä½†ä¸€ä¸ªéœ€æ±‚å¯èƒ½å¯¹åº”åˆ°å¤šä¸ªæœåŠ¡ï¼Œè¿™æ—¶ä¾¿éœ€è¦è°ƒç”¨ä¸åŒæœåŠ¡çš„æ¥å£ï¼Œå› æ­¤ä¼šå‡ºç°è·¨åŸŸã€‚

åŒæºç­–ç•¥ä»…å­˜åœ¨äºæµè§ˆå™¨å®¢æˆ·ç«¯ï¼Œä¸å­˜åœ¨ Androidã€iOSã€NodeJSã€Pythonã€Java ç­‰å…¶ä»–ç¯å¢ƒã€‚

âš ï¸ **æ³¨æ„**ï¼šè·¨åŸŸè¯·æ±‚èƒ½æˆåŠŸå‘é€ï¼ŒæœåŠ¡ç«¯èƒ½æ¥æ”¶è¯·æ±‚å¹¶æ­£å¸¸è¿”å›ç»“æœï¼Œåªæ˜¯ç»“æœè¢«æµè§ˆå™¨æ‹¦æˆªäº†ã€‚

## è·¨æºç½‘ç»œè®¿é—®

ä¸¥æ ¼æ¥è¯´ï¼Œæµè§ˆå™¨å¹¶ä¸æ˜¯æ‹’ç»æ‰€æœ‰çš„è·¨åŸŸè¯·æ±‚ï¼Œå®é™…ä¸Šæ‹’ç»çš„æ˜¯è·¨åŸŸçš„è¯»æ“ä½œã€‚

åŒæºç­–ç•¥æ§åˆ¶äº†ä¸åŒæºä¹‹é—´çš„äº¤äº’ï¼Œè¿™äº›äº¤äº’é€šå¸¸åˆ†ä¸ºä¸‰ç±»ï¼š

- âœ… é€šå¸¸æµè§ˆå™¨å…è®¸è¿›è¡Œè·¨åŸŸ **å†™æ“ä½œ**ï¼ˆCross-origin writesï¼‰ï¼Œå¦‚é“¾æ¥ã€é‡å®šå‘ä»¥åŠè¡¨å•æäº¤
- âœ… é€šå¸¸æµè§ˆå™¨å…è®¸è·¨åŸŸ **èµ„æºåµŒå…¥**ï¼ˆCross-origin embeddingï¼‰ï¼Œå¦‚ `img`ã€`script` æ ‡ç­¾
- âŒ é€šå¸¸æµè§ˆå™¨ä¸å…è®¸è·¨åŸŸ **è¯»æ“ä½œ**ï¼ˆCross-origin readsï¼‰ï¼Œä½†å¸¸å¯ä»¥é€šè¿‡å†…åµŒèµ„æºæ¥å·§å¦™åœ°è¿›è¡Œè¯»å–è®¿é—®ã€‚ä¾‹å¦‚å¯ä»¥è¯»å–åµŒå¥—å›¾ç‰‡çš„é«˜åº¦å’Œå®½åº¦ï¼Œè°ƒç”¨å†…åµŒè„šæœ¬çš„æ–¹æ³•

## è§£å†³æ–¹æ¡ˆ

- CORS è·¨åŸŸèµ„æºå…±äº«
- Node ä»£ç†è·¨åŸŸ
- Nginx ä»£ç†è·¨åŸŸ
- JSONP
- WebSocket
- window.postMessage
- document.domain + iframe
- window.location.hash + iframe
- window.name + iframe

### CORS

CORS äº¦å³ [è·¨åŸŸèµ„æºå…±äº«](../http/access-control)ï¼Œæ˜¯ä¸€ç§ HTTP æœºåˆ¶ï¼Œå®ƒä½¿ç”¨é¢å¤–çš„ HTTP å“åº”å¤´æ¥å‘Šè¯‰æµè§ˆå™¨è®©å…¶è¿è¡Œåœ¨ä¸€ä¸ª `origin` (`domain`) ä¸Šçš„ Web åº”ç”¨è¢«å‡†è®¸è®¿é—®æ¥è‡ª **ä¸åŒæºæœåŠ¡å™¨** ä¸Šçš„æŒ‡å®šçš„èµ„æºã€‚å½“ä¸€ä¸ªèµ„æºä»ä¸è¯¥èµ„æºæœ¬èº«æ‰€åœ¨çš„æœåŠ¡å™¨ **ä¸åŒçš„åŸŸã€åè®®æˆ–ç«¯å£** è¯·æ±‚ä¸€ä¸ªèµ„æºæ—¶ï¼Œèµ„æºä¼šå‘èµ·ä¸€ä¸ª **è·¨åŸŸ HTTP è¯·æ±‚**ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œé€šå¸¸ä½¿ç”¨ CORS æ—¶ï¼Œå¼‚æ­¥è¯·æ±‚ä¼šè¢«åˆ†ä¸º**ç®€å•è¯·æ±‚**å’Œ**éç®€å•è¯·æ±‚**ï¼Œéç®€å•è¯·æ±‚çš„åŒºåˆ«æ˜¯ä¼šå…ˆå‘é€ä¸€ä¸ª **é¢„æ£€è¯·æ±‚**ï¼ˆPreflight Requestï¼‰ã€‚

**æœåŠ¡å™¨é¢„æ£€è¯·æ±‚ / å“åº”å¤´**

| å“åº”å¤´                             | æè¿°                                                         |
| :--------------------------------- | :----------------------------------------------------------- |
| `Access-Control-Allow-Headers`     | è¯·æ±‚å¤´ï¼Œå“åº”å¤´ï¼Œé¢„è¯·æ±‚ï¼ˆæºå¸¦ Cookie æƒ…å†µä¸‹ä¸èƒ½ä¸º `*`ï¼‰       |
| `Access-Control-Allow-Methods`     | è¯·æ±‚å¤´ï¼Œå“åº”å¤´ï¼Œé¢„è¯·æ±‚ï¼ˆæºå¸¦ Cookie æƒ…å†µä¸‹ä¸èƒ½ä¸º `*`ï¼‰       |
| `Access-Control-Allow-Origin`      | å“åº”å¤´ï¼Œé¢„è¯·æ±‚ / æ­£å¸¸è¯·æ±‚ï¼ˆæºå¸¦ Cookie æƒ…å†µä¸‹ä¸èƒ½ä¸º `*`ï¼‰    |
| `Access-Control-Allow-Credentials` | å“åº”å¤´ï¼Œé¢„è¯·æ±‚/æ­£å¸¸è¯·æ±‚ï¼ˆæºå¸¦ Cookie æƒ…å†µä¸‹è¦è®¾ç½®ä¸º `true`ï¼‰ |
| `Access-Control-Max-Age`           | å“åº”å¤´ï¼Œé¢„è¯·æ±‚ï¼ˆå•ä½ `s`ï¼‰                                   |

`Access-Control-Allow-Origin` åªèƒ½é˜»æ­¢æµè§ˆå™¨ç«¯æ‹¿åˆ°æœåŠ¡å™¨è¿”å›æ•°æ®ï¼ŒæœåŠ¡ç«¯çš„å¤„ç†è¿˜æ˜¯ä¼šæ‰§è¡Œï¼Œè¦é…åˆ `token` é‰´æƒä»¤ç‰Œç­‰ç­–ç•¥æ¥é˜²èŒƒã€‚

ğŸ’¡ å®ç°ç»†èŠ‚è¯·å‚è€ƒ [HTTP è·¨åŸŸèµ„æºå…±äº«](../http/access-control)

#### åŸç”Ÿå®ç°

åœ¨ Node.js ä¸­ `CORS` çš„å®ç°ï¼š

```js
app.use(async (ctx, next) => {
  ctx.set('Access-Control-Allow-Origin', ctx.headers.origin);
  ctx.set('Access-Control-Allow-Credentials', true);
  ctx.set('Access-Control-Request-Method', 'PUT,POST,GET,DELETE,OPTIONS');
  ctx.set('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept, cc');
});
```

#### ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶

ä»¥ Koa ä¸ºä¾‹å­ï¼Œè§£ç¦æŒ‡å®šåŸŸåçš„è·¨åŸŸè¯·æ±‚é—®é¢˜ï¼š

```js
const Koa = require('koa');
const cors = require('koa2-cors'); // ä½¿ç”¨æ’ä»¶è§£å†³è·¨åŸŸå¤„ç†

const app = new Koa();

app.use(
  cors({
    origin: function (ctx) {
      if (ctx.url === '/login') {
        // å…è®¸æ¥è‡ªæ‰€æœ‰åŸŸåçš„è¯·æ±‚
        return '*';
      }

      // åªå…è®¸ http://localhost:8080 è¿™ä¸ªåŸŸåçš„è¯·æ±‚
      return 'http://localhost:8080';
    },
    // æŒ‡å®šæœ¬æ¬¡é¢„æ£€è¯·æ±‚çš„æœ‰æ•ˆæœŸï¼Œå•ä½ä¸ºç§’
    maxAge: 5,
    // æ˜¯å¦å…è®¸å‘é€ Cookie
    credentials: true,
    // è®¾ç½®æ‰€å…è®¸çš„ HTTP è¯·æ±‚æ–¹æ³•
    allowMethods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
    // è®¾ç½®æœåŠ¡å™¨æ”¯æŒçš„æ‰€æœ‰å¤´ä¿¡æ¯å­—æ®µ
    allowHeaders: ['Content-Type', 'Authorization', 'Accept'],
    // è®¾ç½®è·å–å…¶ä»–è‡ªå®šä¹‰å­—æ®µ
    exposeHeaders: ['WWW-Authenticate', 'Server-Authorization'],
  })
);
```

> [koa2-cors](https://github.com/zadzbw/koa2-cors) å†…éƒ¨å®ç°è¯·å‚ç…§æºç ã€‚

#### å…³äº Cookie é—®é¢˜

è¦ä¼ é€’ Cookie éœ€è¦æ»¡è¶³ä¸‰ä¸ªæ¡ä»¶ï¼š

1. Web è¯·æ±‚è®¾ç½® `withCredentials`

è¿™é‡Œé»˜è®¤æƒ…å†µä¸‹åœ¨è·¨åŸŸè¯·æ±‚ï¼Œæµè§ˆå™¨æ˜¯ä¸å¸¦ Cookie çš„ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½® `withCredentials` æ¥è¿›è¡Œä¼ é€’ Cookieã€‚

```js
// åŸç”Ÿ XMLHttpRequest çš„è®¾ç½®æ–¹å¼
const xhr = new XHRHttpRequest();
xhr.withCredentials = true;

// Axios è®¾ç½®æ–¹å¼
axios.default.withCredentials = true;
```

2. `Access-Control-Allow-Credentials` ä¸º `true`
3. `Access-Control-Allow-Origin` ä¸ºé `*`

è¿™é‡Œçš„è¯·æ±‚æ–¹å¼ï¼Œåœ¨ Chrome ä¸­æ˜¯èƒ½çœ‹åˆ°è¿”å›å€¼çš„ï¼Œä½†æ˜¯åªè¦ä¸æ»¡è¶³ä»¥ä¸Šå…¶ä¸€ï¼Œæµè§ˆå™¨ä¼šæŠ¥é”™ï¼Œæ— æ³•è·å–æ•°æ®ã€‚

### Node ä»£ç†

åˆ©ç”¨ Node + Express + Http-Proxy-Middleware æ­å»ºä¸€ä¸ª Proxy æœåŠ¡å™¨ã€‚

**å‰ç«¯å®ç°**

```js
const xhr = new XMLHttpRequest();

// å‰ç«¯å¼€å…³ï¼šæµè§ˆå™¨æ˜¯å¦è¯»å†™cookie
xhr.withCredentials = true;

// è®¿é—®http-proxy-middlewareä»£ç†æœåŠ¡å™¨
xhr.open('get', 'http://www.domain1.com:3000/login?user=admin', true);
xhr.send();
```

**æœåŠ¡å™¨å®ç°**

```js
const express = require('express');
const proxy = require('http-proxy-middleware');
const app = express();

app.use(
  '/',
  proxy({
    // ä»£ç†è·¨åŸŸç›®æ ‡æ¥å£
    target: 'http://www.domain2.com:8080',
    changeOrigin: true,

    // ä¿®æ”¹å“åº”å¤´ä¿¡æ¯ï¼Œå®ç°è·¨åŸŸå¹¶å…è®¸å¸¦cookie
    onProxyRes: function (proxyRes, req, res) {
      res.header('Access-Control-Allow-Origin', 'http://www.domain1.com');
      res.header('Access-Control-Allow-Credentials', 'true');
    },

    // ä¿®æ”¹å“åº”ä¿¡æ¯ä¸­çš„cookieåŸŸå
    cookieDomainRewrite: 'www.domain1.com', // å¯ä»¥ä¸ºfalseï¼Œè¡¨ç¤ºä¸ä¿®æ”¹
  })
);

app.listen(3000);
console.log('Proxy server is listen at port 3000...');
```

æœ¬è´¨ä¸Šä¸ CORS ä¸­åˆ—ä¸¾çš„ Koa çš„ä¾‹å­çš„åŸç†æ˜¯ä¸€æ ·çš„ï¼Œå°±æ˜¯è§£é™¤ CORS çš„é™åˆ¶ï¼Œä½†è¿™é‡Œæ›´å¼ºè°ƒçš„æ˜¯å¼€å‘æ—¶ä¸åç«¯æ¥å£è”è°ƒçš„åœºæ™¯ä½¿ç”¨ï¼Œå³å¯åŠ¨å‰ç«¯é¡¹ç›®çš„åŒæ—¶ï¼Œä¹Ÿå¯åŠ¨ä¸€ä¸ªå¼€å‘æœ¬åœ°çš„ Node ä»£ç†æœåŠ¡ç”¨äºè½¬å‘å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘èµ·çš„è¯·æ±‚ã€‚

### Nginx åå‘ä»£ç†

Nginx å¯å®ç°ç”¨äºåå‘ä»£ç†çš„å¼‚æ­¥ Web æœåŠ¡å™¨ï¼Œä»–é™¤äº†ç”¨äºåå‘ä»£ç†ä»¥å¤–è¿˜å¯ä»¥ç”¨äºè´Ÿè½½å‡è¡¡ã€ HTTP ç¼“å­˜ã€‚

```nginx
http {
  include               mime.types;
  default_type          application/octet-stream;
  client_max_body_size  2000M;
  keepalive_timeout     65;

  # è™šæ‹ŸæœåŠ¡å™¨
  server {
    listen       8080;
    server_name  localhost;

    # CORS è®¾ç½®
    # æŒ‡å®šå“åº”èµ„æºæ˜¯å¦å…è®¸ä¸ç»™å®šçš„ origin å…±äº«
    add_header Access-Control-Allow-Origin *;
    # é…ç½®æ˜¯å¦å…è®¸å°†å¯¹è¯·æ±‚çš„å“åº”æš´éœ²ç»™é¡µé¢
    add_header Access-Control-Allow-Credentials 'true';
    # é…ç½®å…è®¸è·¨åŸŸçš„è¯·æ±‚å¤´
    add_header Access-Control-Allow-Headers 'Authorization,Content-Type,Accept,Origin,User-Agent,Cache-Control,X-Mx-ReqToken,X-Requested-With';
    # é…ç½®å…è®¸è·¨åŸŸçš„è¯·æ±‚æ–¹æ³•
    add_header Access-Control-Allow-Methods 'GET,POST,Options';

    # è·³è¿‡æœåŠ¡ç«¯æ ¡éªŒï¼Œç›´æ¥è¿”å› 200
    if ($request_method = 'OPTIONS') {
      return 200;
    }

    location / {
        root        /data/example/dist;
        index       index.html index.htm;
        try_files   $uri /index.html;
        add_header  Cache-Control "private, no-store, no-cache, must-revalidate, proxy-revalidate";
    }

    location /api/ {
        proxy_pass  https://xxx.xxx.xxx/req/;
    }
  }
}
```

- å¯¹äºç®€å•è¯·æ±‚ï¼Œå¦‚ GETï¼Œåªéœ€è¦åœ¨ HTTP Response åæ·»åŠ  Access-Control-Allow-Origin
- å¯¹äºéç®€å•è¯·æ±‚ï¼Œå¦‚ POSTã€PUTã€DELETE ç­‰ï¼Œæµè§ˆå™¨ä¼šåˆ†ä¸¤æ¬¡åº”ç­”ã€‚ç¬¬ä¸€æ¬¡ Preflightï¼ˆ`method: OPTIONS`ï¼‰ï¼Œä¸»è¦éªŒè¯æ¥æºæ˜¯å¦åˆæ³•ï¼Œå¹¶è¿”å›å…è®¸çš„ `Headers` ç­‰ï¼›ç¬¬äºŒæ¬¡æ‰æ˜¯çœŸæ­£çš„ HTTP åº”ç­”ï¼Œæ‰€ä»¥æœåŠ¡å™¨å¿…é¡»å¤„ç† `OPTIONS` åº”ç­”ã€‚

ç”±äºæµè§ˆå™¨ç¬¬ä¸€æ¬¡ Preflight é¢„æ£€ï¼Œå¯¼è‡´æœåŠ¡ç«¯å¯¹å…¶è¯·æ±‚è¿›è¡Œæ ¡éªŒï¼Œä½†æ˜¯æœåŠ¡ç«¯æœ¬èº«æ²¡æœ‰å¼€å¯ CORSï¼Œæ‰€ä»¥ä¼šå¯¼è‡´æœåŠ¡ç«¯è¿”å› 405 Method Not Allowed æˆ–è€… 403 Forbiddenã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ Nginx å¯¹è¯¥è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œç›´æ¥è¿”å› 200ï¼Œè·³è¿‡æœåŠ¡ç«¯æ ¡éªŒã€‚

### JSONP

**å®ç°åŸç†**

åŠ¨æ€åˆ›å»º `<script>` è„šæœ¬æ ‡ç­¾ï¼Œé€šè¿‡è·¨åŸŸè„šæœ¬åµŒå…¥ä¸å—åŒæºç­–ç•¥é™åˆ¶çš„æ–¹æ³•å®ç°è¯·æ±‚ç¬¬ä¸‰æ–¹æœåŠ¡å™¨æ•°æ®å†…å®¹ã€‚é™¤äº†é€‚ç”¨äº `<script>` è„šæœ¬æ ‡ç­¾ï¼ŒHTML ä¸­åŒ…å« `src` å’Œ `href` å±æ€§çš„æ ‡ç­¾å‡ä¸å—åŒæºç­–ç•¥é™åˆ¶ã€‚

**å®ç°æ­¥éª¤**

1. åŠ¨æ€åˆ›å»º `<script>` æ ‡ç­¾
2. æ ‡ç­¾ `src` å±æ€§è®¾ç½®æ¥å£åœ°å€
3. æ¥å£å‚æ•°ï¼Œå¿…é¡»è¦å¸¦ä¸€ä¸ªè‡ªå®šä¹‰å‡½æ•°åï¼Œè¦ä¸ç„¶åå°æ— æ³•è¿”å›æ•°æ®ï¼Œé€šå¸¸ä¸º `callback` æˆ– `cb`
4. é€šè¿‡å®šä¹‰å‡½æ•°åå»æ¥æ”¶åå°è¿”å›æ•°æ®

å‰ç«¯å®ç°ï¼š

```js
// åŠ¨æ€åˆ›å»ºè„šæœ¬æ ‡ç­¾
const script = document.createElement('script');

// è®¾ç½®æ¥å£åœ°å€
script.src = 'http://localhost:8080/api/jsonp?cb=jsonpCallback';

// æ’å…¥é¡µé¢
document.appendChild(script);

// é€šè¿‡å®šä¹‰å›è°ƒå‡½æ•°æ¥æ”¶å“åº”æ•°æ®
window.jsonpCallback = function (res) {
  // do something with response data
};
```

åç«¯å®ç°ï¼š

```js
const Koa = require('koa');
const fs = require('fs');
const app = new Koa();

app.use(async (ctx, next) => {
  if (ctx.path === '/api/jsonp') {
    const { cb } = ctx.query;
    ctx.body = `${cb}(${JSON.stringify({ msg })})`;
    return;
  }
});

app.listen(8080);
```

ç”±äº `<script>` å…ƒç´ è¯·æ±‚çš„è„šæœ¬ï¼Œç›´æ¥ä½œä¸ºä»£ç è¿è¡Œã€‚è¿™æ—¶ï¼Œåªè¦æµè§ˆå™¨å®šä¹‰äº†å›è°ƒå‡½æ•°ï¼Œè¯¥å‡½æ•°å°±ä¼šç«‹å³è°ƒç”¨ã€‚ä½œä¸ºå‚æ•°çš„ JSON æ•°æ®è¢«è§†ä¸º JavaScript å¯¹è±¡ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸²ï¼Œå› æ­¤é¿å…äº†ä½¿ç”¨ `JSON.parse` çš„æ­¥éª¤ã€‚

**ç¼ºç‚¹**ï¼š

- éå¸¸é«˜çš„è·¨ç«™è„šæœ¬æ”»å‡»é£é™©
- åªèƒ½å®ç° GET è¯·æ±‚
- æ¥å£å‡ºç°é”™è¯¯æ—¶ï¼Œå¾ˆéš¾è¿›è¡Œé”™è¯¯è¯†åˆ«å¤„ç†

### WebSocket

WebSocket æ˜¯ä¸€ç§é€šä¿¡åè®®ï¼Œä½¿ç”¨ `ws://`ï¼ˆéåŠ å¯†ï¼‰å’Œ `wss://`ï¼ˆåŠ å¯†ï¼‰ä½œä¸ºåè®®å‰ç¼€ã€‚è¯¥åè®®ä¸å®è¡ŒåŒæºæ”¿ç­–ï¼Œåªè¦æœåŠ¡å™¨æ”¯æŒï¼Œå°±å¯ä»¥é€šè¿‡å®ƒè¿›è¡Œè·¨æºé€šä¿¡ã€‚

ç®€å•æ¥è¯´ï¼ŒWebSocket é€šè¿‡å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´å»ºç«‹æŒä¹…çš„è¿æ¥ï¼ŒåŒæ–¹å¯ä»¥éšæ—¶å‘é€æ•°æ®ã€‚

è¿™ç§æ–¹å¼æœ¬è´¨ä¸Šæ²¡æœ‰ä½¿ç”¨ HTTP åè®®è¿›è¡Œé€šä¿¡ï¼Œå› æ­¤ä¹Ÿæ²¡æœ‰æµè§ˆå™¨è·¨åŸŸçš„é™åˆ¶ã€‚

å‰ç«¯éƒ¨åˆ†ï¼š

```js
const socket = new WebSocket('ws://localhost:8080');

socket.onopen = function () {
  socket.send('Client Socket is openning');
};

socket.onmessage = function (e) {
  console.log(e.data);
};
```

åç«¯éƒ¨åˆ†ï¼š

```js
const WebSocket = require('ws');
const server = new WebSocket.Server({ port: 8080 });

server.on('connection', function (socket) {
  socket.on('message', function (data) {
    socket.send(data);
  });
});
```

ğŸ’¡ å®ç°ç»†èŠ‚è¯·å‚è€ƒ [WebSocket](../../html5-scripting-programming/connectivity/web-socket)

### window.postMessage

é€šå¸¸ï¼Œå¯¹äºä¸¤ä¸ªä¸åŒé¡µé¢çš„è„šæœ¬ï¼Œåªæœ‰å½“æ‰§è¡Œå®ƒä»¬çš„é¡µé¢ä½äºå…·æœ‰ç›¸åŒçš„åè®®ï¼ˆé€šå¸¸ä¸º HTTPSï¼‰ï¼Œç«¯å£å·ï¼ˆ443 ä¸º HTTPS çš„é»˜è®¤å€¼ï¼‰ï¼Œä»¥åŠä¸»æœºï¼ˆä¸¤ä¸ªé¡µé¢çš„æ¨¡æ•° `document.domain` è®¾ç½®ä¸ºç›¸åŒçš„å€¼ï¼‰æ—¶ï¼Œè¿™ä¸¤ä¸ªè„šæœ¬æ‰èƒ½ç›¸äº’é€šä¿¡ã€‚`window.postMessage` æ–¹æ³•æä¾›äº†ä¸€ç§å—æ§æœºåˆ¶æ¥è§„é¿æ­¤é™åˆ¶ï¼Œåªè¦æ­£ç¡®çš„ä½¿ç”¨ï¼Œè¿™ç§æ–¹æ³•å°±å¾ˆå®‰å…¨ã€‚

`window.postMessage(message, targetOrigin)` æ–¹æ³•æ˜¯ HTML5 æ–°å¼•è¿›çš„ç‰¹æ€§ï¼Œå¯ä»¥ä½¿ç”¨å®ƒå‘å…¶ä»–çš„ `window` å¯¹è±¡å‘é€æ¶ˆæ¯ï¼Œæ— è®ºè¿™ä¸ª `window` å¯¹è±¡æ˜¯å±äºåŒæºæˆ–ä¸åŒæºï¼Œç›®å‰ IE8+ã€Firefoxã€Chromeã€Opera ç­‰æµè§ˆå™¨éƒ½å·²ç»æ”¯æŒè¯¥æ–¹æ³•ã€‚

**ç”¨é€”ï¼š**

1. é¡µé¢å’Œå…¶æ‰“å¼€çš„æ–°çª—å£çš„æ•°æ®ä¼ é€’
2. å¤šçª—å£ä¹‹é—´æ¶ˆæ¯ä¼ é€’
3. é¡µé¢ä¸åµŒå¥—çš„ iframe æ¶ˆæ¯ä¼ é€’

```js
otherWindow.postMessage(message, targetOrigin, [transfer]);
```

- `otherWindow`ï¼šå…¶ä»–çª—å£çš„ä¸€ä¸ªå¼•ç”¨ï¼Œæ¯”å¦‚ iframe çš„ `contentWindow` å±æ€§ã€æ‰§è¡Œ `window.open` è¿”å›çš„çª—å£ã€æˆ–è€…æ˜¯å‘½åè¿‡æˆ–æ•°å€¼ç´¢å¼•çš„ `window.iframes`
- `message`ï¼šå°†è¦å‘é€åˆ°å…¶ä»– `window` çš„æ•°æ®
- `targetOrigin`ï¼šé€šè¿‡çª—å£çš„ `origin` å±æ€§æ¥æŒ‡å®šå“ªäº›çª—å£èƒ½æ¥æ”¶åˆ°æ¶ˆæ¯äº‹ä»¶
- `transfer`ï¼ˆå¯é€‰ï¼‰ï¼šæ˜¯ä¸€ä¸²å’Œ `message` åŒæ—¶ä¼ é€’çš„ Transferable å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡çš„æ‰€æœ‰æƒå°†è¢«è½¬ç§»ç»™æ¶ˆæ¯çš„æ¥æ”¶æ–¹ï¼Œè€Œå‘é€ä¸€æ–¹å°†ä¸å†ä¿æœ‰æ‰€æœ‰æƒ

å‘é€ç«¯é¡µé¢ï¼š

```html
<iframe id="iframe" src="http://localhost:8080/" frameborder="0" onload="load()"></iframe>

<script type="application/javascript">
  function load() {
    iframe.contentWindow.postMessage('Hello world!', 'http://localhost:8080/');

    window.onmessage = (e) => {
      console.log(e.data);
    };
  }
</script>
```

æ¥æ”¶ç«¯é¡µé¢ï¼š

```html
<div></div>
<script type="application/javascript">
  window.onmessage = (e) => {
    console.log(e.data);
    // Hello world!
    e.source.postMessage(e.data, e.origin);
  };
</script>
```

ğŸ’¡ å®ç°ç»†èŠ‚è¯·å‚è€ƒ [PostMessage](../../browser-object-model/connectivity/post-message)

### document.domain + iframe

Cookie æ˜¯æœåŠ¡å™¨å†™å…¥æµè§ˆå™¨çš„ä¸€å°æ®µä¿¡æ¯ï¼Œåªæœ‰åŒæºçš„ç½‘é¡µæ‰èƒ½å…±äº«ã€‚

ä½†æ˜¯ï¼Œä¸¤ä¸ªç½‘é¡µä¸€çº§åŸŸåç›¸åŒï¼Œåªæ˜¯äºŒçº§åŸŸåä¸åŒï¼Œæµè§ˆå™¨åªéœ€è¦è®¾ç½® `document.domain` ä¸ºæ›´é«˜çº§åˆ«çš„åŸŸå°±èƒ½å®ç° Cookie å…±äº«ã€‚

ğŸŒ° **ä»£ç ç¤ºä¾‹**

ä»¥ `a.foo.com` å’Œ `b.foo.com` ä¸ºä¾‹ï¼Œåªè¦è®¾ç½®ç›¸åŒçš„ `document.domain`ï¼Œä¸¤ä¸ªç½‘é¡µå°±å¯ä»¥å…±äº« Cookieã€‚

```js
document.domain = 'foo.com';
```

âš ï¸ **æ³¨æ„**ï¼šè¿™ç§æ–¹æ³•åªé€‚ç”¨äº Cookie å’Œ iframe çª—å£ï¼ŒlocalStorage å’Œ IndexDB æ— æ³•é€šè¿‡è¿™ç§æ–¹æ³•ï¼Œè§„é¿åŒæºç­–ç•¥ï¼Œéœ€è¦é‡‡ç”¨ä¸‹æ–‡æåŠçš„ [PostMessage API](#postMessage)ã€‚

å¦å¤–ï¼ŒæœåŠ¡å™¨ä¹Ÿå¯ä»¥åœ¨è®¾ç½® Cookie çš„æ—¶å€™ï¼ŒæŒ‡å®š Cookie çš„æ‰€å±åŸŸåä¸ºä¸€çº§åŸŸåã€‚

```http
Set-Cookie: key=value; domain=.example; path=/
```

é‚£ä¹ˆï¼ŒäºŒçº§åŸŸåå’Œä¸‰çº§åŸŸåä¸ç”¨åšä»»ä½•è®¾ç½®ï¼Œéƒ½å¯ä»¥è¯»å–è¿™ä¸ª Cookieã€‚

### window.location.hash + iframe

å¦‚æœä¸¤ä¸ªç½‘é¡µä¸åŒæºï¼Œå°±æ— æ³•æ‹¿åˆ°å¯¹æ–¹çš„ DOMã€‚å…¸å‹çš„ä¾‹å­æ˜¯ `iframe` çª—å£å’Œ `window.open` æ–¹æ³•æ‰“å¼€çš„çª—å£ï¼Œå®ƒä»¬ä¸çˆ¶çª—å£æ— æ³•é€šä¿¡ã€‚

é€šè¿‡ `url` å¸¦ `hash` é”šç‚¹ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ªéè·¨åŸŸçš„ä¸­é—´é¡µé¢æ¥ä¼ é€’æ•°æ®ã€‚

**å®ç°æµç¨‹**

ä¸€å¼€å§‹ `a.html` ç»™ `c.html` ä¼ ä¸€ä¸ª hash å€¼ï¼Œç„¶å `c.html` æ”¶åˆ° hash å€¼åï¼Œå†æŠŠ hash å€¼ä¼ é€’ç»™ `b.html`ï¼Œæœ€å `b.html` å°†ç»“æœæ”¾åˆ° `a.html` çš„ hash å€¼ä¸­ã€‚åŒæ ·çš„ï¼Œ`a.html` å’Œ `b.html` æ˜¯åŒåŸŸçš„ï¼Œéƒ½æ˜¯ `http://localhost:8000/`ï¼Œè€Œ `c.html` æ˜¯ `http://localhost:8080/`ã€‚

`a.html`ï¼š

```html
<iframe src="http://localhost:8080/hash/c.html#param1"></iframe>

<script type="application/javascript">
  console.log(location.hash);

  window.onhashchange = function () {
    console.log(location.hash);
  };
</script>
```

`b.html`ï¼š

```html
<script type="application/javascript">
  window.parent.parent.location.hash = location.hash;
</script>
```

`c.html`ï¼š

```html
<body></body>
<script type="application/javascript">
  console.log(location.hash);

  const iframe = document.createElement('iframe');

  iframe.src = 'http://localhost:8000/hash/b.html#name2';

  document.body.appendChild(iframe);
</script>
```

### window.name + iframe

`window` å¯¹è±¡çš„ `name` å±æ€§æ˜¯ä¸€ä¸ªå¾ˆç‰¹åˆ«çš„å±æ€§ï¼Œå½“è¯¥ `window` çš„ `location` å˜åŒ–ï¼Œç„¶åé‡æ–°åŠ è½½ï¼Œå®ƒçš„ `name` å±æ€§å¯ä»¥ä¾ç„¶ä¿æŒä¸å˜ã€‚

å…¶ä¸­ `a.html` å’Œ `b.html` æ˜¯åŒåŸŸçš„ï¼Œéƒ½æ˜¯ `http://localhost:8000/`ï¼Œè€Œ `c.html` æ˜¯ `http://localhost:8080/`ã€‚

`a.html`ï¼š

```html
<iframe
  id="iframe"
  frameborder="0"
  src="http://localhost:8080/name/c.html"
  onload="load()"
></iframe>

<script type="application/javascript">
  let first = true;
  // onload äº‹ä»¶ä¼šè§¦å‘ 2 æ¬¡ï¼Œç¬¬ 1 æ¬¡åŠ è½½è·¨åŸŸé¡µï¼Œå¹¶ç•™å­˜æ•°æ®äº window.name
  function load() {
    if (first) {
      // ç¬¬ 1 æ¬¡ onloadï¼ˆè·¨åŸŸé¡µï¼‰æˆåŠŸåï¼Œåˆ‡æ¢åˆ°åŒåŸŸä»£ç†é¡µé¢
      iframe.src = 'http://localhost:8000/name/b.html';
      first = false;
    } else {
      // ç¬¬ 2 æ¬¡ onloadï¼ˆåŒåŸŸ b.html é¡µï¼‰æˆåŠŸåï¼Œè¯»å–åŒåŸŸ window.name ä¸­æ•°æ®
      console.log(iframe.contentWindow.name);
    }
  }
</script>
```

`b.html` ä¸ºä¸­é—´ä»£ç†é¡µï¼Œä¸ `a.html` åŒåŸŸï¼Œå†…å®¹ä¸ºç©ºã€‚

```html
<div></div>
```

`c.html`ï¼š

```html
<script type="application/javascript">
  window.name = 'Hello world!';
</script>
```

## é˜»æ­¢è·¨æºè®¿é—®

- é˜»æ­¢è·¨åŸŸå†™æ“ä½œï¼Œåªè¦æ£€æµ‹è¯·æ±‚ä¸­çš„ä¸€ä¸ªä¸å¯æµ‹çš„æ ‡è®°ï¼ˆCSRF tokenï¼‰å³å¯ï¼Œè¿™ä¸ªæ ‡è®°è¢«ç§°ä¸º [Cross-Site Request Forgery (CSRF)](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_%28CSRF%29) æ ‡è®°ã€‚å¿…é¡»ä½¿ç”¨è¿™ä¸ªæ ‡è®°æ¥é˜»æ­¢é¡µé¢çš„è·¨ç«™è¯»æ“ä½œã€‚
- é˜»æ­¢è·¨ç«™åµŒå…¥ï¼Œéœ€è¦ç¡®ä¿ä½ çš„èµ„æºä¸èƒ½æ˜¯ä»¥ä¸Šåˆ—å‡ºçš„å¯åµŒå…¥èµ„æºæ ¼å¼ã€‚å¤šæ•°æƒ…å†µä¸‹æµè§ˆå™¨éƒ½ä¸ä¼šéµå®ˆ `Content-Type` æ¶ˆæ¯å¤´ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨åœ¨ HTML æ–‡æ¡£ä¸­æŒ‡å®š `<script>` æ ‡è®°ï¼Œåˆ™æµè§ˆå™¨å°†å°è¯•å°† HTML è§£æä¸º JavaScriptã€‚ å½“æ‚¨çš„èµ„æºä¸æ˜¯æ‚¨ç½‘ç«™çš„å…¥å£ç‚¹æ—¶ï¼Œæ‚¨è¿˜å¯ä»¥ä½¿ç”¨ CSRF ä»¤ç‰Œæ¥é˜²æ­¢åµŒå…¥ã€‚
- é˜»æ­¢èµ„æºçš„è·¨ç«™è¯»å–ï¼Œéœ€è¦ä¿è¯è¯¥èµ„æºæ˜¯ä¸å¯åµŒå…¥çš„ã€‚é˜»æ­¢åµŒå…¥è¡Œä¸ºæ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºåµŒå…¥èµ„æºé€šå¸¸å‘å…¶æš´éœ²ä¿¡æ¯ã€‚

## å‚è€ƒèµ„æ–™

- [ğŸ“– MDN: æµè§ˆå™¨çš„åŒæºç­–ç•¥](https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy)
- [ğŸ“ æµè§ˆå™¨åŒæºæ”¿ç­–åŠå…¶è§„é¿æ–¹æ³•](http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html)
- [ğŸ“ æˆ‘çŸ¥é“çš„è·¨åŸŸä¸å®‰å…¨](https://juejin.im/post/5a6320d56fb9a01cb64ee191)
- [ğŸ“ 10 ç§è·¨åŸŸè§£å†³æ–¹æ¡ˆï¼ˆé™„ç»ˆææ–¹æ¡ˆï¼‰](https://mp.weixin.qq.com/s/Nk8YPYQDUJOKgQ9Qa7byag)
