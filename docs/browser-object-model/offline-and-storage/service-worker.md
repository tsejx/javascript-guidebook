---
nav:
  title: BOM
  order: 5
group:
  title: ç¦»çº¿ä¸å­˜å‚¨ API
  order: 12
title: Service Worker
order: 6
---

# Service Worker

Service Worker ä¹Ÿç§°æœåŠ¡å·¥ä½œçº¿ç¨‹ï¼Œæ˜¯æµè§ˆå™¨åœ¨åå°ç‹¬ç«‹ç½‘é¡µè¿è¡Œçš„è„šæœ¬ï¼Œä¹Ÿç®—ä½œæ˜¯ JavaScript å·¥ä½œçº¿ç¨‹ã€‚å®ƒæ— æ³•ç›´æ¥è®¿é—® DOMï¼Œå› æ­¤ï¼Œå¦‚æœä½ éœ€è¦æ“ä½œé¡µé¢çš„ DOM èŠ‚ç‚¹çš„è¯ï¼Œå¯ä»¥é€šè¿‡ Â [postMessage](https://html.spec.whatwg.org/multipage/workers.html#dom-worker-postmessage)Â  æ¥è·Ÿæƒ³æ§åˆ¶çš„é¡µé¢è¿›è¡Œé€šä¿¡ã€‚ Service Worker ä¸­çš„ API å¤§é‡é‡‡ç”¨ Promise æ–¹å¼è®¾è®¡ï¼Œå› æ­¤ä»£ç æ¯”è¾ƒå‹å¥½ã€‚

åœ¨å…¼å®¹æ€§æ–¹é¢ï¼Œ Chrome Firefox Opera éƒ½å·²ç»æ”¯æŒï¼Œ Microsoft Edge ç°åœ¨ä¹Ÿè¡¨ç¤ºå…¬å¼€æ”¯æŒã€‚è€Œä¹‹å‰ Safari å› ä¸ºä¸è®¡åˆ’æ”¯æŒè¢«å¾ˆå¤šå¼€å‘è€…åæ§½ï¼Œè®¤ä¸ºå®ƒå°†ä¼šæ˜¯ä¸‹ä¸€ä»£ IE ã€‚è¿«äºå‹åŠ›ä¸‹ï¼Œç° Safari ä¹Ÿ[æš—ç¤ºæœªæ¥ä¼šè¿›è¡Œå¼€å‘](https://trac.webkit.org/wiki/FiveYearPlanFall2015)ã€‚

å¦‚æœç½‘ç«™è¦ä½¿ç”¨ Service Worker ï¼Œä¼ è¾“åè®®å¿…é¡»ä¸º HTTPS ã€‚å› ä¸º Service Worker ä¸­ä¼šæ¶‰åŠåˆ°è¯·æ±‚æ‹¦æˆªï¼Œæ‰€ä»¥å¿…é¡»ä½¿ç”¨ HTTPS åè®®æ¥ä¿è¯å®‰å…¨ã€‚ å¦å¤–ï¼Œå¦‚æœéœ€è¦æœ¬åœ°è°ƒè¯• Service Worker çš„è¯ï¼ŒÂ `localhost`Â  æ˜¯è¢«æ”¯æŒçš„ã€‚

## æ¦‚è¿°

è‹¥æƒ³ç†è§£ Service Workers ç›¸å…³çš„ä¸€åˆ‡ï¼Œä½ é¦–å…ˆåº”è¯¥é˜…è¯»ä¸€ä¸‹ä¹‹å‰å‘å¸ƒçš„æœ‰å…³ [Web Workers](https://github.com/Troland/how-javascript-works/blob/master/worker) çš„æ–‡ç« ã€‚

å¤§ä½“ä¸Šï¼ŒService Worker æ˜¯ä¸€ç§ Web Workerï¼Œæ›´å‡†ç¡®åœ°è¯´ï¼Œå®ƒæ›´åƒæ˜¯ä¸€ä¸ª [Shared Worker](https://developer.mozilla.org/en-US/docs/Web/API/SharedWorker)ã€‚

- Service Worker è¿è¡Œåœ¨å…¶å…¨å±€è„šæœ¬ä¸Šä¸‹æ–‡ä¸­
- ä¸æŒ‡å®šå’ŒæŸä¸ªç½‘é¡µç»‘å®š
- ä¸èƒ½å¤Ÿè®¿é—® DOM

Service Worker æ¥å£ä¹‹æ‰€ä»¥è®©äººæ„Ÿåˆ°å…´å¥‹çš„åŸå› ä¹‹ä¸€å³å®ƒæ”¯æŒç½‘ç»œåº”ç”¨ç¦»çº¿è¿è¡Œï¼Œè¿™ä½¿å¾—å¼€å‘è€…èƒ½å¤Ÿå®Œå…¨æ§åˆ¶ç½‘ç»œåº”ç”¨çš„è¡Œä¸ºã€‚

## ç”Ÿå‘½å‘¨æœŸ

Service Worker çš„ç”Ÿå‘½å‘¨æœŸå’Œç½‘é¡µå®Œå…¨ä¸ç›¸å…³ã€‚å®ƒç”±ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š

- ä¸‹è½½ï¼ˆDownloadï¼‰
- å®‰è£…ï¼ˆInstallï¼‰
- æ¿€æ´»ï¼ˆActivateï¼‰

### ä¸‹è½½

è¿™å‘ç”Ÿäºæµè§ˆå™¨ä¸‹è½½åŒ…å« Service Worker ç›¸å…³ä»£ç çš„ Â `.js`Â  æ–‡ä»¶ã€‚

### å®‰è£…

ä¸ºäº†åœ¨ç½‘ç»œåº”ç”¨ä¸­ä½¿ç”¨ Service Workerï¼Œé¦–å…ˆå¾—åœ¨ JavaScript ä»£ç ä¸­å¯¹å…¶è¿›è¡Œæ³¨å†Œã€‚å½“ Service Worker æ³¨å†Œçš„æ—¶å€™ï¼Œå®ƒä¼šè®©æµè§ˆå™¨åœ¨åå°å¼€å§‹å®‰è£… Service Worker çš„æ­¥éª¤ã€‚

å½“ä½ çš„åº”ç”¨ä¹‹å‰æœªæ³¨å†Œè¿‡ Service Worker çš„è¯ï¼Œé‚£ä¹ˆç¬¬ä¸€æ­¥å°†ä¼šæ˜¯æ³¨å†Œç¯èŠ‚ã€‚

```js
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker
      .register('/sw.js')
      .then(registeration => {
        // success
      })
      .catch(err => {
        // error
      });
  });
}
```

è¯·æ³¨æ„ï¼Œä»¥ä¸Š `'/sw.js'` ä»£è¡¨ Service Worker ä½œç”¨åŸŸçš„èŒƒå›´ä¸ºæ ¹åŸŸï¼ˆä¹Ÿå°±æ˜¯ Service Worker è„šæœ¬çš„ä½ç½®ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä½¿ä½ çš„é¡µé¢åœ¨ `'/example/a.html'` ä¸­ä¹Ÿå±äºè¯¥ Service Worker çš„æ§åˆ¶èŒƒå›´ã€‚

Chrome æµè§ˆå™¨ä¸‹ï¼Œå¯ä»¥åœ¨ Â `chrome://inspect /#service-workers`Â  ä¸­ï¼ŒæŸ¥çœ‹æœåŠ¡å·¥ä½œçº¿ç¨‹æ˜¯å¦å·²ç»æ³¨å†Œã€‚å¦‚æœè°ƒè¯•çš„è¯ï¼Œç”¨éšèº«æ¨¡å¼æ‰“å¼€çª—å£ä¼šéå¸¸æ–¹ä¾¿ï¼Œå› ä¸ºä»éšèº«çª—å£åˆ›å»ºçš„ä»»ä½•æ³¨å†Œå’Œç¼“å­˜åœ¨è¯¥çª—å£å…³é—­åå‡å°†è¢«æ¸…é™¤ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œä»¥ä¸Šä»£ç æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š

- éœ€è¦è¿›è¡Œç‰¹æ€§æ£€æµ‹ï¼Œåˆ¤æ–­æµè§ˆå™¨æ˜¯å¦æ”¯æŒã€‚
- æœ€å¥½åœ¨é¡µé¢æ‰€æœ‰èµ„æºéƒ½å·²ç»åŠ è½½å®Œæ¯•åï¼Œè¿™ä¸ªæ—¶å€™å»åŠ è½½ Service Worker æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„æ—¶é—´ç‚¹ã€‚å› ä¸ºåœ¨ç§»åŠ¨ç«¯ï¼Œé¡µé¢æ‰“å¼€é¦–å±æ—¶é—´éå¸¸å…³é”®ã€‚

åœ¨å®‰è£…é˜¶æ®µï¼Œæœ€å¥½åŠ è½½å’Œç¼“å­˜ä¸€äº›é™æ€èµ„æºã€‚ä¸€æ—¦é™æ€èµ„æºç¼“å­˜æˆåŠŸï¼ŒService Worker çš„å®‰è£…ä¹Ÿå°±å®Œæˆäº†ã€‚å€˜è‹¥åŠ è½½å¤±è´¥ï¼Service Worker å°†ä¼šé‡è¯•ã€‚ä¸€æ—¦å®‰è£…æˆåŠŸï¼Œé™æ€èµ„æºä¹Ÿå°±ç¼“å­˜æˆåŠŸäº†ã€‚

å‡è®¾ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®ç½‘ç»œåº”ç”¨ã€‚ç°åœ¨è¿˜æ²¡æœ‰æ³¨å†Œ Service Workerï¼Œè€Œä¸”æµè§ˆå™¨æ— æ³•äº‹å…ˆçŸ¥æ™“æ˜¯å¦ä¼šæœ€ç»ˆå®‰è£…å®ƒã€‚å¦‚æœè¿›è¡Œå®‰è£…ï¼Œåˆ™æµè§ˆå™¨å°†ä¼šä¸ºå¢åŠ çš„çº¿ç¨‹å¼€è¾Ÿé¢å¤–çš„ CPU å’Œå†…å­˜ï¼Œè€Œè¿™äº›èµ„æºåŸæœ¬æ˜¯ç”¨æ¥æ¸²æŸ“ç½‘é¡µçš„ã€‚

`load` äº‹ä»¶ä¼šåŠ è½½å®Œæ‰€æœ‰çš„èµ„æºæ¯”å¦‚å›¾ç‰‡ï¼Œæ ·å¼ä¹‹åè§¦å‘ã€‚

æœ€ç»ˆçš„ç»“æœå³æ˜¯å¦‚æœåœ¨é¡µé¢ä¸­å®‰è£… Service Workerï¼Œå°†æœ‰å¯èƒ½å¯¼è‡´é¡µé¢å»¶è¿ŸåŠ è½½å’Œæ¸²æŸ“ï¼ä¸èƒ½å¤Ÿè®©ç”¨æˆ·å°½å¿«åœ°è®¿é—®ç½‘é¡µã€‚

éœ€è¦æ³¨æ„çš„æ˜¯è¿™åªä¼šå‘ç”Ÿåœ¨ç¬¬ä¸€æ¬¡è®¿é—®é¡µé¢çš„æ—¶å€™ã€‚åç»­çš„é¡µé¢è®¿é—®ä¸ä¼šè¢« Service Worker çš„å®‰è£…æ‰€å½±å“ã€‚ä¸€æ—¦åœ¨é¦–æ¬¡è®¿é—®é¡µé¢çš„æ—¶å€™æ¿€æ´»äº† Service Worker ï¼Œå®ƒå°±å¯ä»¥å¤„ç†åç»­çš„é¡µé¢è®¿é—®æ‰€è§¦å‘çš„é¡µé¢åŠ è½½/ç¼“å­˜äº‹ä»¶ã€‚è¿™æ˜¯æ­£ç¡®çš„ï¼ŒService Worker éœ€è¦åŠ è½½å¥½ä»¥å¤„ç†æœ‰é™çš„ç½‘ç»œå¸¦å®½ã€‚

### æ¿€æ´»

å®‰è£…å®Œä¹‹åä¸‹ä¸€æ­¥å³æ¿€æ´»ã€‚è¯¥æ­¥éª¤æ˜¯æ“ä½œä¹‹å‰ç¼“å­˜èµ„æºçš„ç»ä½³æ—¶æœºã€‚

ä¸€æ—¦æ¿€æ´»ï¼ŒService Worker å°±å¯ä»¥å¼€å§‹æ§åˆ¶åœ¨å…¶ä½œç”¨åŸŸå†…çš„æ‰€æœ‰é¡µé¢ã€‚ä¸€ä¸ªæœ‰è¶£çš„äº‹å®å³ï¼šæ³¨å†Œäº† Service Worker çš„é¡µé¢ç›´åˆ°å†æ¬¡åŠ è½½çš„æ—¶å€™æ‰ä¼šè¢« Service Worker è¿›è¡Œå¤„ç†ã€‚å½“ Service Worker å¼€å§‹è¿›è¡Œæ§åˆ¶ï¼Œå®ƒæœ‰ä»¥ä¸‹å‡ ç§çŠ¶æ€ï¼š

- å¤„ç†æ¥è‡ªé¡µé¢çš„ç½‘ç»œæˆ–è€…æ¶ˆæ¯è¯·æ±‚æ‰€è§¦å‘çš„ fetch åŠ message äº‹ä»¶
- ä¸­æ­¢ä»¥èŠ‚çº¦å†…å­˜

ä»¥ä¸‹å³å…¶ç”Ÿå‘½å‘¨æœŸï¼š

![ServiceWorkerç”Ÿå‘½å‘¨æœŸ-æ¿€æ´»](/Users/mrsingsing/Desktop/9ffdbf83-64b9-4a9f-a15c-44282fe47d5e.png)

## å¤„ç† Service Worker å†…éƒ¨çš„å®‰è£…è¿‡ç¨‹

åœ¨å—æ§é¡µé¢è¿è¡Œæ³¨å†Œ Service Worker çš„è¿‡ç¨‹ä¸­ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹ Service Worker è„šæœ¬ä¸­å‘ç”Ÿçš„äº‹æƒ…ï¼Œå®ƒç›‘å¬ Service Worker å®ä¾‹çš„ Â `install`Â  äº‹ä»¶ã€‚

ä»¥ä¸‹ä¸ºå¤„ç† `install` å®‰è£…äº‹ä»¶æ‰€éœ€è¦æ‰§è¡Œçš„æ­¥éª¤ï¼š

- æ‰“å¼€ç¼“å­˜ç©ºé—´
- ç¼“å­˜æ–‡ä»¶
- ç¡®è®¤æ˜¯å¦æ‰€æœ‰çš„é™æ€èµ„æºå·²ç¼“å­˜

```js
const CACHE_NAME = 'my-web-app-cache';
const urlsToCache = ['/', '/styles/base.css', '/dist/bundle.js'];

self.addEventListener('install', event => {
  // å¼€å§‹ç¼“å­˜æ–‡ä»¶
  // event.waitUntilä½¿ç”¨promiseæ¥è·å¾—å®‰è£…æ—¶é•¿åŠå®‰è£…æ˜¯å¦å¤±è´¥
  event.waitUntil(
    caches.open(CACHE_NAME).then(function(cache) {
      console.log('æˆåŠŸæ‰“å¼€ç¼“å­˜ç©ºé—´');
      return cache.addAll(urlsToCache);
    })
  );
});
```

è¯·æ³¨æ„ï¼Œè¿™é‡Œé¢æœ‰ä¸ªç¼“å­˜ç©ºé—´çš„æ¦‚å¿µï¼Œä¹Ÿå³ `caches.open` é‡Œçš„å‚æ•°ã€‚å› ä¸ºæ¯ä¸ªé¡µé¢å¯¹åº”çš„ç¼“å­˜ç©ºé—´å¯èƒ½ä¸ç›¸åŒï¼Œæœ‰äº†ç¼“å­˜ç©ºé—´åä¹Ÿèƒ½æ›´å¥½çš„å¯¹ç¼“å­˜è¿›è¡Œæ§åˆ¶ã€‚æ‰“å¼€ç¼“å­˜ç©ºé—´åï¼Œä¹‹åå†è°ƒç”¨ `cache.addAll()` å¹¶ä¼ å…¥æ–‡ä»¶æ•°ç»„è¿›è¡Œç¼“å­˜ã€‚

ä¸Šè¿°ä¸­ï¼Œæ‰€æœ‰çš„æ–‡ä»¶éƒ½æˆåŠŸç¼“å­˜æ‰ç®—æˆåŠŸï¼Œå¦‚æœæœ‰ä»»ä½•æ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼Œé‚£ä¹ˆå®‰è£…æ­¥éª¤å°±ä¼šå¤±è´¥ã€‚æ‰€ä»¥å¦‚æœç¼“å­˜åˆ—è¡¨è¿‡é•¿çš„è¯ï¼Œå°†ä¼šå¢åŠ ç¼“å­˜å¤±è´¥çš„å‡ ç‡ã€‚

å¦‚æœ `sw.js` ä¸€ç›´éƒ½ä¸å˜åŒ–çš„è¯ï¼Œé‚£ä¹ˆ `install` å®‰è£…äº‹ä»¶åªæœ‰åœ¨é¦–æ¬¡å®‰è£…çš„æ—¶å€™æ‰ä¼šè°ƒç”¨ã€‚

å¤„ç† Â `install`Â  äº‹ä»¶å®Œå…¨æ˜¯å¯é€‰ï¼Œå½“ä¸è¿›è¡Œå¤„ç†çš„æ—¶å€™ï¼Œè·³è¿‡ä»¥ä¸Šå‡ ä¸ªæ­¥éª¤å³å¯ã€‚

## ç¼“å­˜è¿è¡Œæ—¶è¯·æ±‚

è¯¥éƒ¨åˆ†æ‰æ˜¯å¹²è´§ã€‚åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°å¦‚ä½•æ‹¦æˆªè¯·æ±‚ç„¶åè¿”å›å·²åˆ›å»ºçš„ç¼“å­˜ï¼ˆä»¥åŠåˆ›å»ºæ–°çš„ç¼“å­˜ï¼‰ã€‚

å½“ Service Worker å®‰è£…å®Œæˆä¹‹åï¼Œç”¨æˆ·ä¼šå¯¼èˆªåˆ°å¦ä¸€ä¸ªé¡µé¢æˆ–è€…åˆ·æ–°å½“å‰é¡µé¢ï¼ŒService Worker å°†ä¼šè§¦å‘ fetch äº‹ä»¶ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªæ¼”ç¤ºäº†å¦‚ä½•è¿”å›ç¼“å­˜çš„é™æ€èµ„æºæˆ–æ‰§è¡Œä¸€ä¸ªæ–°çš„è¯·æ±‚å¹¶ç¼“å­˜è¿”å›ç»“æœçš„è¿‡ç¨‹çš„ç¤ºä¾‹ï¼š

```js
self.addEventListener('fetch', function(event) {
  event.respondWith(
    // è¯¥æ–¹æ³•æŸ¥è¯¢è¯·æ±‚ç„¶åè¿”å›Service Workeråˆ›å»ºçš„ä»»ä½•ç¼“å­˜æ•°æ®
    caches.match(event.request).then(function(response) {
      // è‹¥æœ‰ç¼“å­˜,åˆ™è¿”å›
      if (response) {
        return response;
      }

      // å¤åˆ¶è¯·æ±‚ã€‚è¯·æ±‚æ˜¯ä¸€ä¸ªæµä¸”åªèƒ½è¢«ä½¿ç”¨ä¸€æ¬¡ã€‚å› ä¸ºä¹‹å‰å·²ç»é€šè¿‡ç¼“å­˜ä½¿ç”¨è¿‡ä¸€æ¬¡äº†ï¼Œæ‰€ä»¥ä¸ºäº†åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨fetch,éœ€è¦å¤åˆ¶ä¸‹è¯¥è¯·æ±‚
      const fetchRequest = event.request.clone();

      // æ²¡æœ‰æ‰¾åˆ°ç¼“å­˜ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰§è¡Œfetchä»¥å‘èµ·è¯·æ±‚å¹¶è¿”å›è¯·æ±‚æ•°æ®
      return fetch(fetchRequest).then(function(response) {
        // æ£€æµ‹è¿”å›æ•°æ®æ˜¯å¦æœ‰æ•ˆ
        if (!response || response.status !== 200 || !response.type !== 'basic') {
          return response;
        }

        // å¤åˆ¶è¿”å›æ•°æ®,å› ä¸ºå®ƒä¹Ÿæ˜¯æµã€‚å› ä¸ºæˆ‘ä»¬æƒ³è¦æµè§ˆå™¨å’Œç¼“å­˜ä¸€æ ·ä½¿ç”¨è¿”å›æ•°æ®,æ‰€ä»¥å¿…é¡»å¤åˆ¶å®ƒã€‚è¿™æ ·å°±æœ‰ä¸¤ä¸ªæµ
        const responseToCache = response.clone();

        caches.open(CACHE_NAME).then(function(cache) {
          // æŠŠè¯·æ±‚æ·»åŠ åˆ°ç¼“å­˜ä¸­ä»¥å¤‡ä¹‹åçš„æŸ¥è¯¢ç”¨
          cache.put(event.request, responseToCache);
        });

        return response;
      });
    })
  );
});
```

ä¸Šè¿°æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼šæœ‰ç¼“å­˜çš„è¯ç›´æ¥è¿”å›ç¼“å­˜æ–‡ä»¶ï¼Œæ²¡ç¼“å­˜çš„è¯è·å–æºæ–‡ä»¶å¹¶è¿”å›ã€‚å¦‚æœåšçš„å¥½çš„è¯ï¼Œå¯ä»¥åœ¨å‘ç°æ²¡ç¼“å­˜çš„æ—¶å€™ï¼ŒæŠŠå®ƒå…ˆç¼“å­˜ä¸‹æ¥ï¼Œå†è¿›è¡Œè¿”å›ã€‚

å¤§æ¦‚çš„æµç¨‹å¦‚ä¸‹ï¼š

- `event.respondWith()` ä¼šå†³å®šå¦‚ä½•å“åº” `fetch` äº‹ä»¶ã€‚ `caches.match()` æŸ¥è¯¢è¯·æ±‚ç„¶åè¿”å›ä¹‹å‰åˆ›å»ºçš„ç¼“å­˜ä¸­çš„ä»»æ„ç¼“å­˜æ•°æ®å¹¶è¿”å› promiseã€‚
- å¦‚æœæœ‰ï¼Œåˆ™è¿”å›è¯¥ç¼“å­˜æ•°æ®ã€‚
- å¦åˆ™ï¼Œæ‰§è¡Œ `fetch` ã€‚
- æ£€æŸ¥è¿”å›çš„çŠ¶æ€ç æ˜¯å¦æ˜¯ `200`ã€‚åŒæ—¶æ£€æŸ¥å“åº”ç±»å‹æ˜¯å¦ä¸º basicï¼Œå³æ£€æŸ¥è¯·æ±‚æ˜¯å¦åŒåŸŸã€‚å½“å‰åœºæ™¯ä¸ç¼“å­˜ç¬¬ä¸‰æ–¹èµ„æºçš„è¯·æ±‚ã€‚
- æŠŠè¿”å›æ•°æ®æ·»åŠ åˆ°ç¼“å­˜ä¸­ã€‚

å› ä¸ºè¯·æ±‚å’Œå“åº”éƒ½æ˜¯æµè€Œæµæ•°æ®åªèƒ½è¢«ä½¿ç”¨ä¸€æ¬¡ï¼Œæ‰€ä»¥å¿…é¡»è¿›è¡Œå¤åˆ¶ã€‚è€Œä¸”ç”±äºç¼“å­˜å’Œæµè§ˆå™¨éƒ½éœ€è¦ä½¿ç”¨å®ƒä»¬ï¼Œæ‰€ä»¥å¿…é¡»è¿›è¡Œå¤åˆ¶ã€‚

## æ›´æ–° Service Worker

å½“ç”¨æˆ·è®¿é—®ç½‘ç»œåº”ç”¨çš„æ—¶å€™ï¼Œæµè§ˆå™¨ä¼šåœ¨åå°è¯•å›¾é‡æ–°ä¸‹è½½ Service Worker æ–‡ä»¶ã€‚

æµè§ˆå™¨ä¸€æ—¦åˆ¤æ–­åˆ°æ–°çš„æœåŠ¡å·¥ä½œçº¿ç¨‹æ–‡ä»¶ä¸å…¶å½“å‰æ‰€ç”¨æ–‡ä»¶å­˜åœ¨**å­—èŠ‚å·®å¼‚**ï¼Œåˆ™å°†å…¶è§†ä¸ºâ€œæ–°æœåŠ¡å·¥ä½œçº¿ç¨‹â€ã€‚æ¥ä¸‹æ¥å°±ä¼šåšä»¥ä¸‹äº‹æƒ…ï¼š

1. æ–°çš„æœåŠ¡å·¥ä½œçº¿ç¨‹å¯åŠ¨ï¼Œå¹¶è§¦å‘ `install` å®‰è£…äº‹ä»¶ã€‚
2. æ­¤æ—¶ï¼Œæ—§æœåŠ¡å·¥ä½œçº¿ç¨‹ä»æ§åˆ¶ç€å½“å‰é¡µé¢ï¼Œå› æ­¤æ–°æœåŠ¡å·¥ä½œçº¿ç¨‹å°†è¿›å…¥ `waiting` ç­‰å¾…çŠ¶æ€ã€‚
3. å½“ç½‘ç«™ä¸Šå½“å‰æ‰“å¼€çš„é¡µé¢å…³é—­æ—¶ï¼Œæ—§æœåŠ¡å·¥ä½œçº¿ç¨‹å°†ä¼šè¢«ç»ˆæ­¢ï¼Œæ–°æœåŠ¡å·¥ä½œçº¿ç¨‹å°†ä¼šå–å¾—æ§åˆ¶æƒã€‚
4. æ–°æœåŠ¡å·¥ä½œçº¿ç¨‹å–å¾—æ§åˆ¶æƒåï¼Œå°†ä¼šè§¦å‘å…¶ `activate` æ¿€æ´»äº‹ä»¶ã€‚

é€šå¸¸åœ¨ `activate` æ¿€æ´»äº‹ä»¶ä¸­ï¼Œæˆ‘ä»¬ä¼šæ¸…é™¤æ—§ç‰ˆæœ¬çš„ç¼“å­˜ã€‚

ä¸ºä»€ä¹ˆæ‰€æœ‰è¿™ä¸€åˆ‡æ˜¯å¿…é¡»çš„å‘¢ï¼Ÿè¿™æ˜¯ä¸ºäº†é¿å…åœ¨ä¸åŒé€‰é¡¹å¡ä¸­åŒæ—¶è¿è¡Œä¸åŒç‰ˆæœ¬çš„çš„ç½‘ç»œåº”ç”¨æ‰€é€ æˆçš„é—®é¢˜ï¼Œä¸€äº›åœ¨ç½‘é¡µä¸­å®é™…å­˜åœ¨çš„é—®é¢˜ä¸”æœ‰å¯èƒ½ä¼šäº§ç”Ÿæ–°çš„ BUGï¼ˆæ¯”å¦‚å½“åœ¨æµè§ˆå™¨ä¸­æœ¬åœ°å­˜å‚¨æ•°æ®çš„æ—¶å€™å´æ‹¥æœ‰ä¸åŒçš„æ•°æ®åº“ç»“æ„ï¼‰ã€‚

## ä»ç¼“å­˜ä¸­åˆ é™¤æ•°æ®

`activate` å›è°ƒä¸­æœ€ä¸ºå¸¸è§çš„æ­¥éª¤å³ç¼“å­˜ç®¡ç†ã€‚å› ä¸ºè‹¥æƒ³åˆ é™¤å®‰è£…æ­¥éª¤ä¸­è€æ—§çš„ç¼“å­˜ï¼Œè€Œè¿™åˆä¼šå¯¼è‡´ Service Workers æ— æ³•è·å–è¯¥ç¼“å­˜ä¸­çš„æ–‡ä»¶æ•°æ®ï¼Œæ‰€ä»¥ï¼Œè¿™æ—¶å€™éœ€è¦è¿›è¡Œç¼“å­˜ç®¡ç†ã€‚

è¿™é‡Œæœ‰ä¸€ä¸ªç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•æŠŠæœªåœ¨ç™½åå•ä¸­çš„ç¼“å­˜åˆ é™¤ï¼ˆè¯¥æƒ…å†µä¸‹ï¼Œä»¥ `page-1` æˆ–è€… `page-2` æ¥è¿›è¡Œå‘½åï¼‰ï¼š

```js
self.addEventListener('activate', function(event) {
  const cacheWhitelist = ['page-1', 'page-2'];

  event.waitUntil(
    // è·å¾—ç¼“å­˜ä¸­æ‰€æœ‰é”®
    caches.keys().then(function(cacheNames) {
      return Promise.all(
        // éå†æ‰€æœ‰çš„ç¼“å­˜æ–‡ä»¶
        cacheNames.map(function(cacheName) {
          // è‹¥ç¼“å­˜æ–‡ä»¶ä¸åœ¨ç™½åå•ä¸­ï¼Œåˆ é™¤ä¹‹
          if (cacheWhitelist.indexOf(cacheName) === -1) {
            return caches.delete(cacheName);
          }
        })
      );
    })
  );
});
```

## æ³¨æ„äº‹é¡¹

### Cookie è®¾ç½®

åœ¨ Service Worker ä¸­ä½¿ç”¨ `fetch` çš„æ—¶å€™ï¼Œè¯·æ±‚å¤´ä¸­é»˜è®¤ä¸åŒ…å« Cookieï¼Œå¦‚æœè¦æ·»åŠ  Cookie çš„è¯ï¼Œéœ€è¦å¢åŠ  `credentials` å‚æ•°ã€‚

```js
fetch(url, {
  credentials: 'include',
});
```

### HTTPS è¦æ±‚

å½“å¤„äºå¼€å‘é˜¶æ®µçš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡ localhost æ¥ä½¿ç”¨ Service Workers ï¼Œä½†å½“å¤„äºå‘å¸ƒç¯å¢ƒçš„æ—¶å€™ï¼Œå¿…é¡»éƒ¨ç½²å¥½ HTTPSï¼ˆè¿™ä¹Ÿæ˜¯ä½¿ç”¨ HTTPS çš„æœ€åä¸€ä¸ªåŸå› äº†ï¼‰ã€‚

å¯ä»¥åˆ©ç”¨ Service Worker åŠ«æŒç½‘ç»œè¿æ¥å’Œä¼ªé€ å“åº”æ•°æ®ã€‚å¦‚æœä¸ä½¿ç”¨ HTTPSï¼Œç½‘ç»œåº”ç”¨ä¼šå®¹æ˜“é­å—[ä¸­é—´äºº](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) æ”»å‡»ã€‚

ä¸ºäº†ä¿è¯å®‰å…¨ï¼Œå¿…é¡»é€šè¿‡ HTTPS åœ¨é¡µé¢ä¸Šæ³¨å†Œ Service Workersï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯æµè§ˆå™¨æ¥æ”¶åˆ°çš„ Service Worker æ²¡æœ‰åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­è¢«ç¯¡æ”¹ã€‚

## åº”ç”¨åœºæ™¯

ä»¥ä¸‹ç½—åˆ—äº†å‡ ç‚¹å½“å‰ä»¥åŠå°†æ¥ Service Worker èƒ½åšçš„äº‹æƒ…ï¼š

- æ‹¦æˆªç½‘ç»œ
- ç¦»çº¿ç¼“å­˜ï¼šå¯ä»¥å°† H5 åº”ç”¨ä¸­ä¸å˜åŒ–çš„èµ„æºæˆ–è€…å¾ˆå°‘å˜åŒ–çš„èµ„æºé•¿ä¹…çš„å­˜å‚¨åœ¨å®¢æˆ·ç«¯ï¼Œæå‡åŠ è½½é€Ÿåº¦ã€é™ä½æµé‡æ¶ˆè€—ã€é™ä½æœåŠ¡å™¨å‹åŠ›ã€‚å¦‚ä¸­é‡åº¦çš„ H5 æ¸¸æˆã€æ¡†æ¶æ•°æ®ç‹¬ç«‹çš„ Web èµ„è®¯å®¢æˆ·ç«¯ã€Web é‚®ä»¶å®¢æˆ·ç«¯ç­‰ã€‚
- æ¶ˆæ¯æ¨é€ï¼šæ¿€æ´»æ²‰ç¡çš„ç”¨æˆ·ï¼Œæ¨é€å³æ—¶ä¿¡æ¯ã€å…¬å‘Šé€šå‘Šï¼Œæ¿€å‘æ›´æ–°ç­‰ã€‚å¦‚ Web èµ„è®¯å®¢æˆ·ç«¯ã€Web å³æ—¶é€šè®¯å·¥å…·ã€H5 æ¸¸æˆç­‰è¿è¥äº§å“ã€‚
- äº‹ä»¶åŒæ­¥ï¼šç¡®ä¿ Web ç«¯äº§ç”Ÿçš„ä»»åŠ¡å³ä½¿åœ¨ç”¨æˆ·å…³é—­äº† Web é¡µé¢ä¹Ÿå¯ä»¥é¡ºåˆ©å®Œæˆã€‚å¦‚ Web é‚®ä»¶å®¢æˆ·ç«¯ã€Web å³æ—¶é€šè®¯å·¥å…·ç­‰ã€‚
- å®šæ—¶åŒæ­¥ï¼ˆæœªæ¥æ”¯æŒï¼‰ï¼šå‘¨æœŸæ€§çš„è§¦å‘ Service Worker è„šæœ¬ä¸­çš„å®šæ—¶åŒæ­¥äº‹ä»¶ï¼Œå¯å€ŸåŠ©å®ƒæå‰åˆ·æ–°ç¼“å­˜å†…å®¹ã€‚å¦‚ Web èµ„è®¯å®¢æˆ·ç«¯ã€‚
- åœ°ç†å›´æ ï¼ˆæœªæ¥æ”¯æŒï¼‰ï¼šåœ°ç†å›´æ ï¼ˆGeo-fencingï¼‰æ˜¯ LBS çš„ä¸€ç§æ–°åº”ç”¨ï¼Œå°±æ˜¯ç”¨ä¸€ä¸ªè™šæ‹Ÿçš„æ …æ å›´å‡ºä¸€ä¸ªè™šæ‹Ÿåœ°ç†è¾¹ç•Œã€‚å½“æ‰‹æœºè¿›å…¥ã€ç¦»å¼€æŸä¸ªç‰¹å®šåœ°ç†åŒºåŸŸï¼Œæˆ–åœ¨è¯¥åŒºåŸŸå†…æ´»åŠ¨æ—¶ï¼Œæ‰‹æœºå¯ä»¥æ¥æ”¶è‡ªåŠ¨é€šçŸ¥å’Œè­¦å‘Šã€‚

## æµè§ˆå™¨æ”¯æŒæƒ…å†µ

Service Workers æ‹¥æœ‰è‰¯å¥½çš„æµè§ˆå™¨å…¼å®¹æ€§ã€‚

```jsx | inline
import React from 'react';
import img from '../../assets/service-worker/server-worker-compatibility.png';

export default () => <img alt="Service Workers æµè§ˆå™¨å…¼å®¹æ€§" src={img} width={800} />;
```

## æ€»ç»“

é™¤äº†ç¦»çº¿ç¼“å­˜å¤–ï¼Œåˆ©ç”¨ Service Worker è¿˜å¯ä»¥åšå¾ˆå¤šä»¤äººå…´å¥‹çš„åŠŸèƒ½ã€‚æ¯”å¦‚ï¼š

- å®¢æˆ·ç«¯ç¼–è¯‘ï¼ˆæŠŠåŸæ¥æœ¬åœ°/æœåŠ¡ç«¯ Webpack æ‰“åŒ…ç¼–è¯‘çš„äº‹æƒ…æ”¾åœ¨ `client` ä¸­ï¼‰
- é¢„è¯·æ±‚ Prefetchï¼ˆSSR æ¡†æ¶ next.js æä¾›äº† Link ç»„ä»¶æ¥å®ç°é¢„è¯·æ±‚æ¸²æŸ“ï¼‰

åˆ©ç”¨ Service Worker èƒ½å¤§å¤§æå‡ Progress Web Appï¼ˆPWAï¼‰ çš„ä½“éªŒï¼Œç°åœ¨å„å¤§å‚å•†éƒ½è¡¨ç¤ºæ”¯æŒï¼Œä¹Ÿä»£è¡¨äº†æœªæ¥çš„è¶‹åŠ¿ã€‚å¦å¤–ï¼Œ Google æä¾›äº†ä¸€å¥— Service Worker åº“ï¼Œå¯ä»¥æ¶ˆé™¤æœåŠ¡å·¥ä½œçº¿ç¨‹æ ·æ¿æ–‡ä»¶ä»£ç ï¼Œä»è€Œç®€åŒ–å¼€å‘å·¥ä½œã€‚

- [sw-precache](https://github.com/GoogleChrome/sw-precache/)â€”ä¸æ„å»ºæµç¨‹é›†æˆï¼Œä»¥ç”ŸæˆæœåŠ¡å·¥ä½œçº¿ç¨‹ï¼Œç”¨äºé¢„ç¼“å­˜é™æ€èµ„äº§ï¼Œä¾‹å¦‚ Application Shellã€‚
- [sw-toolbox](https://github.com/GoogleChrome/sw-toolbox/)â€”å®ç°å¸¸è§è¿è¡Œæ—¶ç¼“å­˜æ¨¡å¼ï¼Œä¾‹å¦‚åŠ¨æ€å†…å®¹ã€API è°ƒç”¨ä»¥åŠç¬¬ä¸‰æ–¹èµ„æºï¼Œå®ç°æ–¹æ³•å°±åƒç¼–å†™ README ä¸€æ ·ç®€å•ã€‚
- sw-offline-google-analyticsâ€”ä¸´æ—¶ä¿ç•™å¹¶é‡è¯• Analytics è¯·æ±‚ï¼Œä»¥é¿å…è¯·æ±‚å› ç½‘ç»œæ–­å¼€è¿æ¥è€Œä¸¢å¤±ã€‚

---

**å‚è€ƒæ–‡æ¡£ï¼š**

- [å®˜æ–¹è‹±æ–‡æ–‡æ¡£ï¼šService Worker](https://www.w3.org/TR/service-workers)
- [åˆè¯† Service Worker åŠç®€å•åº”ç”¨](https://github.com/Leslie2014/blog/issues/1)
- [è…¾è®¯æµè§ˆå™¨æœåŠ¡ï¼šService Worker ç®€ä»‹](https://x5.tencent.com/product/service-worker.html)
- [ServiceWorker çš„ç”Ÿå‘½å‘¨æœŸ](http://www.fly63.com/article/detial/234)
- [Githubï¼šService Worker Explained](https://github.com/neal1991/articles-translator/blob/master/Service%20worker%E4%BB%8B%E7%BB%8D)
- [CSDNï¼šService Worker å…¥é—¨ - PWA å¼ºä¾èµ–äº Service Worker](https://blog.csdn.net/ztguang/article/details/53750479)
- [ğŸ“Githubï¼šService Worker 101](https://github.com/delapuente/service-workers-101)
- [Service Worker - first draft published](https://jakearchibald.com/2014/service-worker-first-draft/)
